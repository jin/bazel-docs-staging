<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Android Instrumentation Tests - Bazel</title>

    <link rel="canonical" href="/versions/0.17.1/android-instrumentation-test.html">

    <!-- Webfont -->
    <link href="//fonts.googleapis.com/css?family=RobotoDraft:300,400,500,700|Source+Code+Pro:400,500,700" rel="stylesheet">

    <link rel="shortcut icon" type="image/png" href="/images/favicon.ico">

    <!-- Bootstrap -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/font-awesome.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom stylesheet -->
    <link rel="stylesheet" type="text/css" href="/css/main.css" />

    <!-- metadata -->
    <meta name="og:title" content="Android Instrumentation Tests"/>
    <meta name="og:image" content="/images/bazel-og-image.png"/>

    <!-- google search console verification -->
    <meta name="google-site-verification" content="ftWLOiP2hnDW4Cw3LUGEaXU83RVIpiyxwaXFFhoakzs" />
  </head>

  <body>
        <nav id="common-nav" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://www.bazel.build/">
            <img class="navbar-logo" src="/images/bazel-navbar.svg">
          </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/bazelbuild/bazel">GitHub</a></li>
          </ul>
          <form class="navbar-form navbar-right" action="/search.html" id="cse-search-box">
            <div class="form-group">
              <input type="hidden" name="cx" value="012346921571893344015:xv_nfgpzbu4">
              <input type="hidden" name="cof" value="FORID:10">
              <input type="hidden" name="ie" value="UTF-8">
              <input type="search" name="q" class="form-control input-sm" placeholder="Search">
            </div>
          </form>
          <ul class="nav navbar-nav navbar-right">
            <li>
              <a href="/">Documentation</a>
            </li>
            <li>
              <a href="https://www.bazel.build/contributing.html">Contribute</a>
            </li>
            <li>
              <a href="https://blog.bazel.build">Blog</a>
            </li>
            <li><a href="https://twitter.com/bazelbuild" class="nav-icon"><i class="fa fa-twitter"></i></a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/bazel" class="nav-icon"><i class="fa fa-stack-overflow"></i></a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>


    <div class="page-title-bar">
      <div class="container">
        <h1>Documentation</h1>
      </div>
    </div>

    <div class="container vpad">
      <div class="row">
        <div class="col-md-3">
          <a class="btn btn-default btn-lg btn-block sidebar-toggle"
              data-toggle="collapse" href="#sidebar-nav" aria-expanded="false"
              aria-controls="sidebar-nav">
            <i class="glyphicon glyphicon-menu-hamburger"></i> Navigation
          </a>
          <nav class="sidebar collapse" id="sidebar-nav">
           <h3>Home</h3>
            <ul class="sidebar-nav">
              <li><a href="/versions/master/bazel-overview.html">Bazel Overview</a></li>
              <li><a href="/versions/master/bazel-vision.html">Bazel Vision</a></li>
              <li><a href="/versions/master/getting-started.html">Getting Started</a></li>
              <li><a href="/versions/master/skylark/backward-compatibility.html">Backward Compatibility</a></li>
            </ul>

           <h3>Using Bazel</h3>
            <ul class="sidebar-nav">

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#installing-menu" aria-expanded="false"
                    aria-controls="installing-menu">
                  Installing Bazel<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="installing-menu">
                   <li><a href="/versions/master/install.html">Installation Overview</a></li>
                   <li><a href="/versions/master/install-ubuntu.html">Installing on Ubuntu</a></li>
                   <li><a href="/versions/master/install-redhat.html">Installing on Fedora/CentOS</a></li>
                   <li><a href="/versions/master/install-os-x.html">Installing on macOS</a></li>
                   <li><a href="/versions/master/install-windows.html">Installing on Windows</a></li>
                   <li><a href="/versions/master/install-compile-source.html">Compiling from Source</a></li>
                   <li><a href="/versions/master/completion.html">Command-Line Completion</a></li>
                   <li><a href="/versions/master/ide.html">Integrating with IDEs</a></li>
                 </ul>
                </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#tutorials-menu" aria-expanded="false"
                    aria-controls="tutorials-menu">
                  Tutorials<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="tutorials-menu">
                   <li><a href="/versions/master/tutorial/java.html">Building a Java Project</a></li>
                   <li><a href="/versions/master/tutorial/cpp.html">Building a C++ Project</a></li>
                   <li><a href="/versions/master/tutorial/android-app.html">Building an Android App</a></li>
                   <li><a href="/versions/master/tutorial/ios-app.html">Building an iOS App</a></li>
                   <li><a href="/versions/master/skylark/tutorial-sharing-variables.html">Sharing Variables</a></li>
                   <li><a href="/versions/master/skylark/tutorial-creating-a-macro.html">Creating a Macro</a></li>
                 </ul>
              </li>

              <li><a href="/versions/master/build-ref.html">Bazel Concepts</a></li>
              <li><a href="/versions/master/guide.html">User's Guide</a></li>
              <li><a href="/versions/master/external.html">External Dependencies</a></li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#query-menu" aria-expanded="false"
                    aria-controls="query-menu">
                  Queries<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="query-menu">
                  <li><a href="/versions/master/query-how-to.html">Bazel query</a></li>
                  <li><a href="/versions/master/cquery.html">Bazel cquery</a></li>
                  <li><a href="/versions/master/user-manual.html#aquery">Bazel aquery</a></li>
                  <li><a href="/versions/master/query.html">Query Language</a></li>
                </ul>
              </li>

              <li><a href="/versions/master/configurable-attributes.html">Configurable Attributes</a></li>
              <li><a href="/versions/master/best-practices.html">Best Practices</a></li>
              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#remote-execution-menu" aria-expanded="false"
                    aria-controls="remote-execution-menu">
                  Remote Execution<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="remote-execution-menu">
                   <li><a href="/versions/master/remote-execution.html">Remote Execution Overview</a></li>
                   <li><a href="/versions/master/remote-execution-rules.html">Guidelines for Remote Execution</a></li>
                   <li>
                      <a class="sidebar-nav-heading" data-toggle="collapse"
                          href="#troubleshoot-remote-execution-menu" aria-expanded="false"
                          aria-controls="troubleshoot-remote-execution-menu">
                        Troubleshooting Remote Execution<span class="caret"></span>
                      </a>
                      <ul class="collapse sidebar-nav sidebar-submenu" id="troubleshoot-remote-execution-menu">
                         <li><a href="/versions/master/remote-execution-sandbox.html">Troubleshooting Remote Execution with Bazel Sandbox</a></li>
                         <li><a href="/versions/master/workspace-log.html">Finding non-hermetic behavior in WORKSPACE rules</a></li>
                      </ul>
                  </li>
                   <li><a href="/versions/master/remote-execution-ci.html">Configuring Bazel CI for Remote Execution Rule Testing</a></li>
                 </ul>
              </li>

              <li><a href="/versions/master/remote-caching.html">Remote Caching</a></li>
             </ul>

           <h3>Rules</h3>
           <ul class="sidebar-nav">
             <li><a href="/versions/master/be/overview.html">Build Encyclopedia</a></li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#android-menu" aria-expanded="false"
                    aria-controls="android-menu">
                  Android<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="android-menu">
                  <li><a href="/versions/master/bazel-and-android.html">Android Resources</a></li>
                  <li><a href="/versions/master/mobile-install.html">Using mobile-install</a></li>
                  <li><a href="/versions/master/android-instrumentation-test.html">Android Instrumentation Tests</a></li>
                  <li><a href="/versions/master/android-ndk.html">Android NDK</a></li>
                  <li><a href="https://plugins.jetbrains.com/plugin/9185-bazel">Android Studio Plugin</a></li>
                </ul>
              </li>

               <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#apple-menu" aria-expanded="false"
                    aria-controls="apple-menu">
                  Apple<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="apple-menu">
                  <li><a href="/versions/master/bazel-and-apple.html">Apple Resources</a></li>
                  <li><a href="/versions/master/migrate-xcode.html">Migrating from Xcode</a></li>
                  <li><a href="/versions/master/migrate-cocoapods.html">Converting CocoaPods</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#cpp-menu" aria-expanded="false"
                    aria-controls="cpp-menu">
                  C++<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="cpp-menu">
                  <li><a href="/versions/master/bazel-and-cpp.html">C++ Resources</a></li>
                  <li><a href="/versions/master/cpp-use-cases.html">C++ Use Cases</a></li>
                  <li><a href="/versions/master/crosstool-reference.html">Understanding CROSSTOOL</a></li>
                  <li><a href="/versions/master/tutorial/crosstool.html">Tutorial: CROSSTOOL</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#java-menu" aria-expanded="false"
                    aria-controls="java-menu">
                  Java<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="java-menu">
                  <li><a href="/versions/master/bazel-and-java.html">Java Resources</a></li>
                  <li><a href="/versions/master/migrate-maven.html">Migrating from Maven</a></li>
                  <li><a href="/versions/master/generate-workspace.html">Converting Maven Dependencies</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#javascript-menu" aria-expanded="false"
                    aria-controls="javascript-menu">
                  JavaScript<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="javascript-menu">
                  <li><a href="/versions/master/bazel-and-javascript.html">JavaScript Resources</a></li>
                  <li><a href="/versions/master/build-javascript.html">Building JavaScript</a></li>
                </ul>
              </li>

           </ul>

           <h3>Reference</h3>
           <ul class="sidebar-nav">
             <li><a href="/versions/master/user-manual.html">Commands and Options</a></li>
             <li><a href="/versions/master/skylark/build-style.html">BUILD Style Guide</a></li>
             <li><a href="/versions/master/command-line-reference.html">Command Line Reference</a></li>
             <li><a href="/versions/master/test-encyclopedia.html">Writing Tests</a></li>
             <li><a href="/versions/master/build-event-protocol.html">Build Event Protocol</a></li>
             <li><a href="/versions/master/output_directories.html">Output Directory Layout</a></li>
             <li><a href="/versions/master/platforms.html">Platforms</a></li>
             <li><a href="/versions/master/toolchains.html">Toolchains</a></li>
           </ul>

            <h3>Extending Bazel</h3>
           <ul class="sidebar-nav">
              <li><a href="/versions/master/skylark/concepts.html">Extension Overview</a></li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#starlark-concepts" aria-expanded="false"
                    aria-controls="starlark-concepts">
                  Concepts<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="starlark-concepts">
                  <li><a href="/versions/master/skylark/macros.html">Macros</a></li>
                  <li><a href="/versions/master/skylark/rules.html">Rules</a></li>
                  <li><a href="/versions/master/skylark/depsets.html">Depsets</a></li>
                  <li><a href="/versions/master/skylark/aspects.html">Aspects</a></li>
                  <li><a href="/versions/master/skylark/repository_rules.html">Repository Rules</a></li>
                  <li><a href="/versions/master/skylark/faq.html">FAQ</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#starlark-practices" aria-expanded="false"
                    aria-controls="starlark-practices">
                  Best Practices<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="starlark-practices">
                  <li><a href="/versions/master/skylark/bzl-style.html">.bzl Style Guide</a></li>
                  <li><a href="/versions/master/skylark/testing.html">Testing</a></li>
                  <li><a href="https://skydoc.bazel.build" target="_blank">Documenting Rules</a></li>
                  <li><a href="/versions/master/skylark/skylint.html">Linter</a></li>
                  <li><a href="/versions/master/skylark/performance.html">Optimizing Performance</a></li>
                  <li><a href="/versions/master/skylark/deploying.html">Deploying Rules</a></li>
                </ul>
              </li>

              <li><a href="https://github.com/bazelbuild/examples/tree/master/rules">Examples</a></li>
              <li><a href="/versions/master/skylark/lib/skylark-overview.html">API Reference</a></li>
              <li><a href="/versions/master/skylark/language.html">Starlark Language</a></li>
            </ul>
          </nav>
        </div>

        <div class="col-md-9">
          <a id="gh-edit" class="gh-edit default-hidden"><i class="fa fa-pencil" aria-hidden="true"></i> Edit</a>
          <script>
            var versionDocsURLRegex = /\/versions\/[\w\.]+\/(.*)/;
            var ghDocsBazeURL = 'https://github.com/bazelbuild/bazel/tree/master/site/docs/';
            var editButton = document.getElementById('gh-edit');
            // if there is an edit button and we are not in the Build Encyclopedia
            if (editButton
                && window.location.pathname.match(versionDocsURLRegex)
                && window.location.pathname.lastIndexOf('/be/') == -1
                && window.location.pathname.lastIndexOf('/skylark/lib/') == -1) {
              var docFile = window.location.pathname.match(versionDocsURLRegex)[1];
              // some pages are not using markdown :(
              if (docFile !== 'user-manual.html'
                  && docFile !== 'build-ref.html'
                  && docFile !== 'query.html'
                  && docFile !== 'test-encyclopedia.html') {
                docFile = docFile.replace('html', 'md');
              }
              editButton.href = ghDocsBazeURL + docFile;
              editButton.style.visibility = 'visible';
            }
          </script>

          <!-- /versions/master/foo/bar -> ["master", "foo", "bar"] -->
          <!-- /versions/0.12.3/baz.md -> ["0.12.3", "baz.md"] -->
          

          <p>Documentation for Bazel 0.17.1</p>
          <select id="touchsplashmenu" onchange="location.href=this.value">
              <option value="">Choose a Bazel version</option>
              
              <option value="/versions/master/android-instrumentation-test.html">master</option>
              
              <option value="/versions/0.19.2/android-instrumentation-test.html">0.19.2</option>
              
              <option value="/versions/0.19.1/android-instrumentation-test.html">0.19.1</option>
              
              <option value="/versions/0.18.1/android-instrumentation-test.html">0.18.1</option>
              
              <option value="/versions/0.17.2/android-instrumentation-test.html">0.17.2</option>
              
              <option value="/versions/0.17.1/android-instrumentation-test.html">0.17.1</option>
              
          </select>

          <h1 id="android-instrumentation-tests">Android Instrumentation Tests</h1>

<p><em>If you’re new to Bazel, please start with the <a href="https://docs.bazel.build/versions/master/tutorial/android-app.html">Building Android with
Bazel</a>
tutorial.</em></p>

<p><img src="/assets/android_test.gif" alt="Running Android instrumentation tests in parallel" /></p>

<p><a href="https://docs.bazel.build/versions/master/be/android.html#android_instrumentation_test"><code class="highlighter-rouge">android_instrumentation_test</code></a>
allows developers to test their apps on Android emulators and devices.
It utilizes real Android framework APIs and the Android Test Library.</p>

<p>For hermeticity and reproducibility, Bazel creates and launches Android
emulators in a sandbox, ensuring that tests always run from a clean state. Each
test gets an isolated emulator instance, allowing tests to run in parallel
without passing states between them.</p>

<p>For more information on Android instrumentation tests, check out the <a href="https://developer.android.com/training/testing/unit-testing/instrumented-unit-tests.html">Android
developer
documentation</a>.</p>

<p>Please file issues in the <a href="https://github.com/bazelbuild/bazel/issues">GitHub issue tracker</a>.</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="#how-it-works">How it works</a></li>
  <li><a href="#prerequisites">Prerequisites</a></li>
  <li><a href="#getting-started">Getting started</a>
    <ul>
      <li><a href="#build-file"><code class="highlighter-rouge">BUILD</code> file</a></li>
      <li><a href="#workspace-dependencies"><code class="highlighter-rouge">WORKSPACE</code> dependencies</a></li>
    </ul>
  </li>
  <li><a href="#maven-dependencies">Maven dependencies</a></li>
  <li><a href="#choosing-an-android_device-target">Choosing an <code class="highlighter-rouge">android_device</code> target</a></li>
  <li><a href="#running-tests">Running tests</a>
    <ul>
      <li><a href="#headless-testing">Headless testing</a></li>
      <li><a href="#gui-testing">GUI testing</a></li>
      <li><a href="#testing-with-a-local-emulator-or-device">Testing with a local emulator or device</a></li>
    </ul>
  </li>
  <li><a href="#sample-projects">Sample projects</a></li>
  <li><a href="#tips">Tips</a>
    <ul>
      <li><a href="#reading-test-logs">Reading test logs</a></li>
      <li><a href="#testing-against-multiple-api-levels">Testing against multiple API levels</a></li>
    </ul>
  </li>
  <li><a href="#known-issues">Known issues</a></li>
  <li><a href="#planned-features">Planned features</a></li>
</ul>

<h1 id="how-it-works">How it works</h1>

<p>When you run <code class="highlighter-rouge">bazel test</code> on an <code class="highlighter-rouge">android_instrumentation_test</code> target for the
first time, Bazel performs the following steps:</p>

<ol>
  <li>Builds the test APK, APK under test, and their transitive dependencies</li>
  <li>Creates, boots, and caches clean emulator states</li>
  <li>Starts the emulator</li>
  <li>Installs the APKs</li>
  <li>Runs tests utilizing the <a href="https://developer.android.com/training/testing/junit-runner.html#using-android-test-orchestrator">Android Test Orchestrator</a></li>
  <li>Shuts down the emulator</li>
  <li>Reports the results</li>
</ol>

<p>In subsequent test runs, Bazel boots the emulator from the clean, cached state
created in step 2, so there are no leftover states from previous runs. Caching
emulator state also speeds up test runs.</p>

<h1 id="prerequisites">Prerequisites</h1>

<p>Ensure your enivornment satisfies the following prerequisites:</p>

<ul>
  <li>
    <p><strong>Linux</strong>. Tested on Ubuntu 14.04 and 16.04.</p>
  </li>
  <li>
    <p><strong>Bazel 0.12.0</strong> or later. Verify the version by running <code class="highlighter-rouge">bazel info release</code>.</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bazel info release
release 0.12.0
</code></pre></div></div>

<ul>
  <li><strong>KVM</strong>. Bazel requires emulators to have <a href="https://developer.android.com/studio/run/emulator-acceleration.html#accel-check">hardware
acceleration</a>
with KVM on Linux. You can follow these
<a href="https://help.ubuntu.com/community/KVM/Installation">installation instructions</a>
for Ubuntu. Run <code class="highlighter-rouge">apt-get install cpu-checker &amp;&amp; kvm-ok</code> to verify that KVM has
the correct configuration. If it prints the following message, you’re good to
go:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kvm-ok
INFO: /dev/kvm exists
KVM acceleration can be used
</code></pre></div></div>

<ul>
  <li><strong>Xvfb</strong>. To run headless tests (for example, on CI servers), Bazel requires
the <a href="https://www.x.org/archive/X11R7.6/doc/man/man1/Xvfb.1.xhtml">X virtual framebuffer</a>.
Install it by running <code class="highlighter-rouge">apt-get install xvfb</code>. Verify that <code class="highlighter-rouge">Xvfb</code> is installed
correctly by running <code class="highlighter-rouge">which Xvfb</code> and ensure that it’s installed at
<code class="highlighter-rouge">/usr/bin/Xvfb</code>:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ which Xvfb
/usr/bin/Xvfb
</code></pre></div></div>

<h1 id="getting-started">Getting started</h1>

<p>Here is a typical target dependency graph of an <code class="highlighter-rouge">android_instrumentation_test</code>:</p>

<p><img src="/assets/android_instrumentation_test.png" alt="The target dependency graph on an Android instrumentation test" /></p>

<h2 id="build-file"><code class="highlighter-rouge">BUILD</code> file</h2>

<p>The graph translates into a <code class="highlighter-rouge">BUILD</code> file like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@gmaven_rules//:defs.bzl"</span><span class="p">,</span> <span class="s">"gmaven_artifact"</span><span class="p">)</span>

<span class="n">android_instrumentation_test</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_test"</span><span class="p">,</span>
    <span class="n">test_app</span> <span class="o">=</span> <span class="s">":my_test_app"</span><span class="p">,</span>
    <span class="n">target_device</span> <span class="o">=</span> <span class="s">"@android_test_support//tools/android/emulated_devices/generic_phone:android_23_x86_qemu2"</span><span class="p">,</span>
<span class="p">)</span>

<span class="c"># Test app and library</span>
<span class="n">android_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_test_app"</span><span class="p">,</span>
    <span class="n">instruments</span> <span class="o">=</span> <span class="s">":my_app"</span><span class="p">,</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="s">"AndroidTestManifest.xml"</span><span class="p">,</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">":my_test_lib"</span><span class="p">],</span>
    <span class="c"># ...</span>
<span class="p">)</span>

<span class="n">android_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_test_lib"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="n">glob</span><span class="p">([</span><span class="s">"javatest/**/*.java"</span><span class="p">]),</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">":my_app_lib"</span><span class="p">,</span>
        <span class="n">gmaven_artifact</span><span class="p">(</span><span class="s">"com.android.support.test.espresso:espresso_core:aar:3.0.1"</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="c"># ...</span>
<span class="p">)</span>

<span class="c"># Target app and library under test</span>
<span class="n">android_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_app"</span><span class="p">,</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="s">"AndroidManifest.xml"</span><span class="p">,</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">":my_app_lib"</span><span class="p">],</span>
    <span class="c"># ...</span>
<span class="p">)</span>

<span class="n">android_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_app_lib"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="n">glob</span><span class="p">([</span><span class="s">"java/**/*.java"</span><span class="p">]),</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">gmaven_artifact</span><span class="p">(</span><span class="s">"com.android.support:design:aar:27.0.2"</span><span class="p">),</span>
        <span class="n">gmaven_artifact</span><span class="p">(</span><span class="s">"com.android.support:support_annotations:jar:27.0.2"</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</code></pre></div></div>

<p>The main attributes of the rule <code class="highlighter-rouge">android_instrumentation_test</code> are:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">test_app</code>: An <code class="highlighter-rouge">android_binary</code> target. This target contains test code and
dependencies like Espresso and UIAutomator. The selected <code class="highlighter-rouge">android_binary</code>
target is required to specify an <code class="highlighter-rouge">instruments</code> attribute pointing to another
<code class="highlighter-rouge">android_binary</code>, which is the app under test.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">target_device</code>: An <code class="highlighter-rouge">android_device</code> target. This target describes the
specifications of the Android emulator which Bazel uses to create, launch and
run the tests. See the <a href="#choosing-an-android_device">section on choosing an Android
device</a> for more information.</p>
  </li>
</ul>

<p>The test app’s <code class="highlighter-rouge">AndroidManifest.xml</code> must include
<a href="https://developer.android.com/studio/test/#configure_instrumentation_manifest_settings">an <code class="highlighter-rouge">&lt;instrumentation&gt;</code> tag</a>.
This tag must specify the attributes for the <strong>package of the target app</strong> and
the <strong>fully qualified class name of the instrumentation test runner</strong>,
<code class="highlighter-rouge">android.support.test.runner.AndroidJUnitRunner</code>.</p>

<p>Here is an example <code class="highlighter-rouge">AndroidTestManifest.xml</code> for the test app:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
          <span class="na">xmlns:tools=</span><span class="s">"http://schemas.android.com/tools"</span>
          <span class="na">package=</span><span class="s">"com.example.android.app.test"</span>
    <span class="na">android:versionCode=</span><span class="s">"1"</span>
    <span class="na">android:versionName=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;instrumentation</span>
        <span class="na">android:name=</span><span class="s">"android.support.test.runner.AndroidJUnitRunner"</span>
        <span class="na">android:targetPackage=</span><span class="s">"com.example.android.app"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;uses-sdk</span>
        <span class="na">android:minSdkVersion=</span><span class="s">"16"</span>
        <span class="na">android:targetSdkVersion=</span><span class="s">"27"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;application</span> <span class="nt">&gt;</span>
       <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;/application&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</code></pre></div></div>

<h2 id="workspace-dependencies"><code class="highlighter-rouge">WORKSPACE</code> dependencies</h2>

<p>In order to use this rule, your project needs to depend on these external
repositories:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">@androidsdk</code>: The Android SDK. Download this through Android Studio.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">@android_test_support</code>: Hosts the test runner, emulator launcher, and
<code class="highlighter-rouge">android_device</code> targets.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">@gmaven_rules</code>: Defines the <code class="highlighter-rouge">maven_jar</code> and <code class="highlighter-rouge">maven_aar</code> targets available on
the <a href="https://maven.google.com">Google Maven repository</a>.</p>
  </li>
</ul>

<p>You can enable these dependencies by adding the following lines to your
<code class="highlighter-rouge">WORKSPACE</code> file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Android SDK</span>
<span class="n">android_sdk_repository</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"androidsdk"</span><span class="p">,</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">"/path/to/sdk"</span><span class="p">,</span> <span class="c"># or set ANDROID_HOME</span>
<span class="p">)</span>

<span class="c"># Android Test Support</span>
<span class="n">ATS_COMMIT</span> <span class="o">=</span> <span class="s">"$COMMIT_HASH"</span>
<span class="n">http_archive</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"android_test_support"</span><span class="p">,</span>
    <span class="n">strip_prefix</span> <span class="o">=</span> <span class="s">"android-test-</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">ATS_COMMIT</span><span class="s">",</span><span class="err">
</span><span class="s">    urls = ["</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">android</span><span class="o">-</span><span class="n">test</span><span class="o">/</span><span class="n">archive</span><span class="o">/%</span><span class="n">s</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span><span class="s">" </span><span class="si">% </span><span class="s">ATS_COMMIT],</span><span class="err">
</span><span class="s">)</span><span class="err">
</span><span class="s">load("</span><span class="nd">@android_test_support</span><span class="o">//</span><span class="p">:</span><span class="n">repo</span><span class="o">.</span><span class="n">bzl</span><span class="s">", "</span><span class="n">android_test_repositories</span><span class="s">")</span><span class="err">
</span><span class="s">android_test_repositories()</span><span class="err">

</span><span class="s"># Google Maven Repository</span><span class="err">
</span><span class="s">GMAVEN_TAG = "</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span><span class="s">"</span><span class="err">
</span><span class="s">http_archive(</span><span class="err">
</span><span class="s">    name = "</span><span class="n">gmaven_rules</span><span class="s">",</span><span class="err">
</span><span class="s">    strip_prefix = "</span><span class="n">gmaven_rules</span><span class="o">-%</span><span class="n">s</span><span class="s">" </span><span class="si">% </span><span class="s">GMAVEN_TAG,</span><span class="err">
</span><span class="s">    urls = ["</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">bazelbuild</span><span class="o">/</span><span class="n">gmaven_rules</span><span class="o">/</span><span class="n">archive</span><span class="o">/%</span><span class="n">s</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span><span class="s">" </span><span class="si">% </span><span class="s">GMAVEN_TAG],</span><span class="err">
</span><span class="s">)</span><span class="err">
</span><span class="s">load("</span><span class="nd">@gmaven_rules</span><span class="o">//</span><span class="p">:</span><span class="n">gmaven</span><span class="o">.</span><span class="n">bzl</span><span class="s">", "</span><span class="n">gmaven_rules</span><span class="s">")</span><span class="err">
</span><span class="s">gmaven_rules()</span><span class="err">
</span></code></pre></div></div>

<h1 id="maven-dependencies">Maven dependencies</h1>

<p>Use the
<a href="https://docs.bazel.build/versions/master/be/workspace.html#maven_jar">maven_jar</a>
repository rule for Maven dependencies not hosted on Google Maven. For example,
to use JUnit 4.12 and Hamcrest 2, add the following lines to your <code class="highlighter-rouge">WORKSPACE</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maven_jar(
    name = "junit_junit",
    artifact = "junit:junit:4.12",
)

maven_jar(
    name = "org_hamcrest_java_hamcrest",
    artifact = "org.hamcrest:java-hamcrest:2.0.0.0",
)
</code></pre></div></div>

<p>Then, you can depend on them in your <code class="highlighter-rouge">BUILD</code> files:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">java_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"test_deps"</span><span class="p">,</span>
    <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s">"//visibility:public"</span><span class="p">],</span>
    <span class="n">exports</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"@junit_junit//jar"</span><span class="p">,</span>
        <span class="s">"@org_hamcrest_java_hamcrest//jar"</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="n">android_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_test_lib"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="o">..</span><span class="p">],</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">":test_deps"</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div>

<p><a href="https://github.com/johnynek/bazel-deps"><code class="highlighter-rouge">bazel-deps</code></a> is another useful tool
for managing Maven dependencies using <a href="https://github.com/johnynek/bazel-deps/blob/master/dependencies.yaml">a <code class="highlighter-rouge">YAML</code>
file</a>.</p>

<p>For dependencies hosted on <a href="https://maven.google.com">Google’s Maven
repository</a>, <a href="https://github.com/bazelbuild/gmaven_rules"><code class="highlighter-rouge">@gmaven_rules</code></a>
provides a simple way to fetch dependencies hosted with <code class="highlighter-rouge">gmaven_artifact</code>.</p>

<p><code class="highlighter-rouge">gmaven_artifact</code> is a macro that maps an artifact’s coordinate to the actual
generated target in
<a href="https://raw.githubusercontent.com/bazelbuild/gmaven_rules/master/gmaven.bzl"><code class="highlighter-rouge">gmaven.bzl</code></a>
(warning: big file!). The packaging type defaults to <code class="highlighter-rouge">jar</code> if it isn’t
specified.</p>

<p>Load the <code class="highlighter-rouge">gmaven_artifact</code> macro at the beginning of your <code class="highlighter-rouge">BUILD</code> file to use
it:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@gmaven_rules//:defs.bzl"</span><span class="p">,</span> <span class="s">"gmaven_artifact"</span><span class="p">)</span>

<span class="n">android_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_app_lib"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="n">glob</span><span class="p">([</span><span class="s">"java/**/*.java"</span><span class="p">]),</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">gmaven_artifact</span><span class="p">(</span><span class="s">"com.android.support:design:aar:27.0.2"</span><span class="p">),</span>
        <span class="n">gmaven_artifact</span><span class="p">(</span><span class="s">"com.android.support:support_annotations:jar:27.0.2"</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</code></pre></div></div>

<h1 id="choosing-an-android_device-target">Choosing an android_device target</h1>

<p><code class="highlighter-rouge">android_instrumentation_test.target_device</code> specifies which Android device to
run the tests on. These <code class="highlighter-rouge">android_device</code> targets are defined in
<a href="https://github.com/google/android-testing-support-library/tree/master/tools/android/emulated_devices"><code class="highlighter-rouge">@android_test_support</code></a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">bazel</span> <span class="n">query</span> <span class="o">--</span><span class="n">output</span><span class="o">=</span><span class="n">build</span> <span class="nd">@android_test_support</span><span class="o">//</span><span class="n">tools</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">emulated_devices</span><span class="o">/</span><span class="n">generic_phone</span><span class="p">:</span><span class="n">android_23_x86_qemu2</span>
<span class="c"># .../external/android_test_support/tools/android/emulated_devices/generic_phone/BUILD:43:1</span>
<span class="n">android_device</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"android_23_x86_qemu2"</span><span class="p">,</span>
  <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s">"//visibility:public"</span><span class="p">],</span>
  <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s">"requires-kvm"</span><span class="p">],</span>
  <span class="n">generator_name</span> <span class="o">=</span> <span class="s">"generic_phone"</span><span class="p">,</span>
  <span class="n">generator_function</span> <span class="o">=</span> <span class="s">"make_device"</span><span class="p">,</span>
  <span class="n">generator_location</span> <span class="o">=</span> <span class="s">"tools/android/emulated_devices/generic_phone/BUILD:43"</span><span class="p">,</span>
  <span class="n">vertical_resolution</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
  <span class="n">horizontal_resolution</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
  <span class="n">ram</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
  <span class="n">screen_density</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
  <span class="n">cache</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
  <span class="n">vm_heap</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
  <span class="n">system_image</span> <span class="o">=</span> <span class="s">"@android_test_support//tools/android/emulated_devices/generic_phone:android_23_x86_qemu2_images"</span><span class="p">,</span>
  <span class="n">default_properties</span> <span class="o">=</span> <span class="s">"@android_test_support//tools/android/emulated_devices/generic_phone:_android_23_x86_qemu2_props"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>The device target names use this template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@android_test_support//tools/android/emulated_devices/${device_type}:${system}_${api_level}_x86_qemu2
</code></pre></div></div>

<p>In order to launch an <code class="highlighter-rouge">android_device</code>, the <code class="highlighter-rouge">system_image</code> for the selected API
level is required. To download the system image, use Android SDK’s
<code class="highlighter-rouge">tools/bin/sdkmanager</code>. For example, to download the system image for
<code class="highlighter-rouge">generic_phone:android_23_x86_qemu2</code>, run <code class="highlighter-rouge">$sdk/tools/bin/sdkmanager
"system-images;android-23;default;x86"</code>.</p>

<p>To see the full list of supported <code class="highlighter-rouge">android_device</code> targets in
<code class="highlighter-rouge">@android_test_support</code>, run the following command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel query 'filter("x86_qemu2$", kind(android_device, @android_test_support//tools/android/emulated_devices/...:*))'
</code></pre></div></div>

<p>Bazel currently supports x86-based emulators only. For better performance,
we also recommend using <code class="highlighter-rouge">QEMU2</code> <code class="highlighter-rouge">android_device</code> targets instead of <code class="highlighter-rouge">QEMU</code> ones.</p>

<h1 id="running-tests">Running tests</h1>

<p>To run tests, add these lines to your project’s <code class="highlighter-rouge">tools/bazel.rc</code> file.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Configurations for testing with Bazel
# Select a configuration by running
# `bazel test //my:target --config={headless, gui, local_device}`

# Headless instrumentation tests
test:headless --test_arg=--enable_display=false

# Graphical instrumentation tests. Ensure that $DISPLAY is set.
test:gui --test_env=DISPLAY
test:gui --test_arg=--enable_display=true

# Testing with a local emulator or device. Ensure that `adb devices` lists the
# device.
# Run tests serially.
test:local_device --test_strategy=exclusive
# Use the local device broker type, as opposed to WRAPPED_EMULATOR.
test:local_device --test_arg=--device_broker_type=LOCAL_ADB_SERVER
# Uncomment and set $device_id if there is more than one connected device.
# test:local_device --test_arg=--device_serial_number=$device_id
</code></pre></div></div>

<p>Then, use one of the configurations to run tests:</p>

<ul>
  <li><code class="highlighter-rouge">bazel test //my/test:target --config=headless</code></li>
  <li><code class="highlighter-rouge">bazel test //my/test:target --config=gui</code></li>
  <li><code class="highlighter-rouge">bazel test //my/test:target --config=local_device</code></li>
</ul>

<p>Use <strong>only one configuration</strong> or tests will fail.</p>

<h2 id="headless-testing">Headless testing</h2>

<p>With <code class="highlighter-rouge">Xvfb</code>, it is possible to test with emulators without the graphical
interface, also known as headless testing. To disable the graphical interface
when running tests, pass the test argument <code class="highlighter-rouge">--enable_display=false</code> to Bazel:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel test //my/test:target --test_arg=--enable_display=false
</code></pre></div></div>

<h2 id="gui-testing">GUI testing</h2>

<p>If the <code class="highlighter-rouge">$DISPLAY</code> environment variable is set, it’s possible to enable the
graphical interface of the emulator while the test is running. To do this, pass
these test arguments to Bazel:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel test //my/test:target --test_arg=--enable_display --test_env=DISPLAY
</code></pre></div></div>

<h2 id="testing-with-a-local-emulator-or-device">Testing with a local emulator or device</h2>

<p>Bazel also supports testing directly on a locally launched emulator or connected
device. Pass the flags
<code class="highlighter-rouge">--test_strategy=exclusive</code> and
<code class="highlighter-rouge">--test_arg=--device_broker_type=LOCAL_ADB_SERVER</code> to enable local testing mode.
If there is more than one connected device, pass the flag
<code class="highlighter-rouge">--test_arg=--device_serial_number=$device_id</code> where <code class="highlighter-rouge">$device_id</code> is the id of
the device/emulator listed in <code class="highlighter-rouge">adb devices</code>.</p>

<h1 id="sample-projects">Sample projects</h1>

<p>If you are looking for canonical project samples, see the <a href="https://github.com/googlesamples/android-testing#experimental-bazel-support">Android testing
samples</a>
for projects using Espresso and UIAutomator.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone https://github.com/googlesamples/android-testing &amp;&amp; cd android-testing
# Set path to Android SDK in WORKSPACE
$ bazel test //ui/... --config=headless
INFO: Analysed 45 targets (1 packages loaded).
INFO: Found 36 targets and 9 test targets...

...

INFO: Elapsed time: 195.665s, Critical Path: 195.22s
INFO: Build completed successfully, 417 total actions
//ui/espresso/BasicSample:BasicSampleInstrumentationTest                 PASSED in 103.7s
//ui/espresso/CustomMatcherSample:CustomMatcherSampleInstrumentationTest PASSED in 113.2s
//ui/espresso/DataAdapterSample:DataAdapterSampleInstrumentationTest     PASSED in 110.2s
//ui/espresso/IdlingResourceSample:IdlingResourceSampleInstrumentationTest PASSED in 102.3s
//ui/espresso/IntentsAdvancedSample:IntentsAdvancedSampleInstrumentationTest PASSED in 98.3s
//ui/espresso/IntentsBasicSample:IntentsBasicSampleInstrumentationTest   PASSED in 103.3s
//ui/espresso/MultiWindowSample:MultiWindowSampleInstrumentationTest     PASSED in 108.3s
//ui/espresso/RecyclerViewSample:RecyclerViewSampleInstrumentationTest   PASSED in 102.9s
//ui/uiautomator/BasicSample:BasicSampleInstrumentationTest              PASSED in 122.6s
</code></pre></div></div>

<h1 id="tips">Tips</h1>

<h2 id="reading-test-logs">Reading test logs</h2>

<p>Use <code class="highlighter-rouge">--test_output=errors</code> to print logs for failing tests, or
<code class="highlighter-rouge">--test_output=all</code> to print all test output. If you’re looking for an
individual test log, go to
<code class="highlighter-rouge">$PROJECT_ROOT/bazel-testlogs/path/to/InstrumentationTestTargetName</code>.</p>

<p>For example, the test logs for <code class="highlighter-rouge">BasicSample</code> canonical project are in
<code class="highlighter-rouge">bazel-testlogs/ui/espresso/BasicSample/BasicSampleInstrumentationTest</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tree bazel-testlogs/ui/espresso/BasicSample/BasicSampleInstrumentationTest
.
├── adb.409923.log
├── broker_logs
│   ├── aapt_binary.10.ok.txt
│   ├── aapt_binary.11.ok.txt
│   ├── adb.12.ok.txt
│   ├── adb.13.ok.txt
│   ├── adb.14.ok.txt
│   ├── adb.15.fail.txt
│   ├── adb.16.ok.txt
│   ├── adb.17.fail.txt
│   ├── adb.18.ok.txt
│   ├── adb.19.fail.txt
│   ├── adb.20.ok.txt
│   ├── adb.21.ok.txt
│   ├── adb.22.ok.txt
│   ├── adb.23.ok.txt
│   ├── adb.24.fail.txt
│   ├── adb.25.ok.txt
│   ├── adb.26.fail.txt
│   ├── adb.27.ok.txt
│   ├── adb.28.fail.txt
│   ├── adb.29.ok.txt
│   ├── adb.2.ok.txt
│   ├── adb.30.ok.txt
│   ├── adb.3.ok.txt
│   ├── adb.4.ok.txt
│   ├── adb.5.ok.txt
│   ├── adb.6.ok.txt
│   ├── adb.7.ok.txt
│   ├── adb.8.ok.txt
│   ├── adb.9.ok.txt
│   ├── android_23_x86_qemu2.1.ok.txt
│   └── exec-1
│       ├── adb-2.txt
│       ├── emulator-2.txt
│       └── mksdcard-1.txt
├── device_logcat
│   └── logcat1635880625641751077.txt
├── emulator_itCqtc.log
├── outputs.zip
├── pipe.log.txt
├── telnet_pipe.log.txt
└── tmpuRh4cy
    ├── watchdog.err
    └── watchdog.out

4 directories, 41 files
</code></pre></div></div>

<h2 id="reading-emulator-logs">Reading emulator logs</h2>

<p>The emulator logs for <code class="highlighter-rouge">android_device</code> targets are stored in the <code class="highlighter-rouge">/tmp/</code>
directory with the name <code class="highlighter-rouge">emulator_xxxxx.log</code>, where <code class="highlighter-rouge">xxxxx</code> is a
randomly-generated sequence of characters.</p>

<p>Use this command to find the latest emulator log:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls -1t /tmp/emulator_*.log | head -n 1
</code></pre></div></div>

<h2 id="testing-against-multiple-api-levels">Testing against multiple API levels</h2>

<p>If you would like to test against multiple API levels, you can use a list
comprehension to create test targets for each API level. For example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">API_LEVELS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"19"</span><span class="p">,</span>
    <span class="s">"20"</span><span class="p">,</span>
    <span class="s">"21"</span><span class="p">,</span>
    <span class="s">"22"</span><span class="p">,</span>
<span class="p">]</span>

<span class="p">[</span><span class="n">android_instrumentation_test</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_test_</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">API_LEVEL</span><span class="p">,</span>
    <span class="n">test_app</span> <span class="o">=</span> <span class="s">":my_test_app"</span><span class="p">,</span>
    <span class="n">target_device</span> <span class="o">=</span> <span class="s">"@android_test_support//tools/android/emulated_devices/generic_phone:android_</span><span class="si">%</span><span class="s">s_x86_qemu2"</span> <span class="o">%</span> <span class="n">API_LEVEL</span><span class="p">,</span>
<span class="p">)</span> <span class="k">for</span> <span class="n">API_LEVEL</span> <span class="ow">in</span> <span class="n">API_LEVELS</span><span class="p">]</span>
</code></pre></div></div>

<h1 id="known-issues">Known issues</h1>

<ul>
  <li><a href="https://github.com/bazelbuild/bazel/issues/4853">Forked adb server processes are not terminated after
tests</a></li>
  <li>While APK building works on all platforms (Linux, macOS, Windows), testing
only works on Linux.</li>
  <li>Even with <code class="highlighter-rouge">--config=local_adb</code>, users still need to specify
<code class="highlighter-rouge">android_instrumentation_test.target_device</code>.</li>
  <li>If using a local device or emulator, Bazel does not uninstall the APKs after
the test. Clean the packages by running this command: <code class="highlighter-rouge">adb shell pm list
packages com.example.android.testing | cut -d ':' -f 2 | tr -d '\r' | xargs
-L1 -t adb uninstall</code></li>
</ul>

<h1 id="planned-features">Planned features</h1>

<ul>
  <li>Code coverage collection</li>
  <li>macOS support</li>
  <li>Windows support</li>
  <li>Improved external dependency management</li>
  <li>Remote test caching and execution</li>
</ul>

<p>We are planning to rewrite the Android rules in <a href="https://docs.bazel.build/versions/master/skylark/concepts.html">Starlark</a>.
The <code class="highlighter-rouge">android_instrumentation_test</code> rule will be part of the rewrite, however,
its usage will remain unchanged from the end-user perspective.</p>

        </div>
      </div>
    </div>

    <!-- Satisfaction Survey -->
    <script async="" defer="" src="//survey.g.doubleclick.net/async_survey?site=oohdpic4fyfp3jcnym6aqkdf3e"></script>

        <footer class="footer">
      <div class="container">
  <div class="row">
    <div class="col-sm-4 col-md-2">
      <p>About</p>
      <ul class="list-unstyled">
        <li><a href="https://github.com/bazelbuild/bazel/wiki/Bazel-Users">Who's Using Bazel?</a></li>
        <li><a href="https://www.bazel.build/roadmap.html">Roadmap</a></li>
        <li><a href="https://www.bazel.build/contributing.html">Contribute</a></li>
        <li><a href="https://www.bazel.build/governance.html">Governance Plan</a></li>
        <li><a href="https://policies.google.com/privacy">Privacy Policy</a></li>
      </ul>
    </div>
    <div class="col-sm-4 col-md-2">
      <p>Support</p>
      <ul class="list-unstyled">
        <li><a href="http://stackoverflow.com/questions/tagged/bazel">Stack Overflow</a></li>
        <li><a href="https://github.com/bazelbuild/bazel/issues">Issue Tracker</a></li>
        <li><a href="/">Documentation</a></li>
        <li><a href="https://www.bazel.build/faq.html">FAQ</a></li>
        <li><a href="https://www.bazel.build/support.html">Support Policy</a></li>
      </ul>
    </div>
    <div class="col-sm-4 col-md-2">
      <p>Stay Connected</p>
      <ul class="list-unstyled">
        <li><a href="https://twitter.com/bazelbuild">Twitter</a></li>
        <li><a href="https://blog.bazel.build">Blog</a></li>
        <li><a href="https://github.com/bazelbuild/bazel">GitHub</a></li>
        <li><a href="https://groups.google.com/forum/#!forum/bazel-discuss">Discussion group</a></li>
      </ul>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <p class="text-muted">&copy; 2018 Google</p>
    </div>
  </div>
</div>

    </footer>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/assets/js/bootstrap.min.js"></script>

    <!-- Anchor JS -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>
    <script>
      // Automatically add anchors and links to all header elements that don't already have them.
      anchors.add();
    </script>

    <script>
      var shiftWindow = function() {
        if (location.hash.length !== 0) {
          window.scrollBy(0, -50);
        }
      };
      window.addEventListener("hashchange", shiftWindow);

      var highlightCurrentSidebarNav = function() {
        var href = location.pathname;
        var item = $('#sidebar-nav [href$="' + href + '"]');
        if (item) {
          var li = item.parent();
          li.addClass("active");

          if (li.parent() && li.parent().is("ul")) {
            do {
              var ul = li.parent();
              if (ul.hasClass("collapse")) {
                ul.collapse("show");
              }
              li = ul.parent();
            } while (li && li.is("li"));
          }
        }
      };

      $(document).ready(function() {
        // Scroll to anchor of location hash, adjusted for fixed navbar.
        window.setTimeout(function() {
          shiftWindow();
        }, 1);

        // Flip the caret when submenu toggles are clicked.
        $(".sidebar-submenu").on("show.bs.collapse", function() {
          var toggle = $('[href$="#' + $(this).attr('id') + '"]');
          if (toggle) {
            toggle.addClass("dropup");
          }
        });
        $(".sidebar-submenu").on("hide.bs.collapse", function() {
          var toggle = $('[href$="#' + $(this).attr('id') + '"]');
          if (toggle) {
            toggle.removeClass("dropup");
          }
        });

        // Highlight the current page on the sidebar nav.
        highlightCurrentSidebarNav();
      });
    </script>

    <!-- Google Analytics tracking code -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-61082125-1', 'auto');
      ga('send', 'pageview');
    </script>

  </body>
</html>

