<!-- /versions/master/foo/bar -> ["master", "foo", "bar"] -->
<!-- /versions/0.12.3/baz.md -> ["0.12.3", "baz.md"] -->





<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Only show Bazel version in title if it's a release -->
    <title>Testing - Bazel 2.0.0</title>

    <link rel="canonical" href="/versions/2.0.0/skylark/testing.html">

    <!-- Webfont -->
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,500,700|Open+Sans:400,600,700,800" rel="stylesheet">

    <link rel="shortcut icon" type="image/png" href="/images/favicon.ico">

    <!-- Bootstrap -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/font-awesome.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom stylesheet -->
    <link rel="stylesheet" type="text/css" href="/css/main.css" />

    <!-- metadata -->
    <meta name="og:title" content="Testing"/>
    <meta name="og:image" content="/images/bazel-og-image.png"/>

    <!-- google search console verification -->
    <meta name="google-site-verification" content="ftWLOiP2hnDW4Cw3LUGEaXU83RVIpiyxwaXFFhoakzs" />
  </head>

  <body>
        <nav id="common-nav" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://www.bazel.build/">
            <img class="navbar-logo" src="/images/bazel-navbar.svg">
          </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/bazelbuild/bazel">GitHub</a></li>
          </ul>
          <form class="navbar-form navbar-right" action="/search.html" id="cse-search-box">
            <div class="form-group">
              <input type="hidden" name="cx" value="009927877080525621790:2pxlpaexqpc">
              <input type="hidden" name="cof" value="FORID:10">
              <input type="hidden" name="ie" value="UTF-8">
              <input type="search" name="q" id="q" class="form-control input-sm" placeholder="Search">
            </div>
          </form>
          <ul class="nav navbar-nav navbar-right">
            <li>
              <a href="/">Documentation</a>
            </li>
            <li>
              <a href="https://www.bazel.build/contributing.html">Contribute</a>
            </li>
            <li>
              <a href="https://blog.bazel.build">Blog</a>
            </li>
            <li><a href="https://twitter.com/bazelbuild" class="nav-icon"><i class="fa fa-twitter"></i></a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/bazel" class="nav-icon"><i class="fa fa-stack-overflow"></i></a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>


    <div class="container vpad">
      <div class="row">
        <div class="col-md-2">
          <a class="btn btn-default btn-lg btn-block sidebar-toggle"
              data-toggle="collapse" href="#sidebar-nav" aria-expanded="false"
              aria-controls="sidebar-nav">
            <i class="glyphicon glyphicon-menu-hamburger"></i> Navigation
          </a>

          <nav class="sidebar collapse" id="sidebar-nav">
            <select onchange="location.href=this.value">
                <option value="" selected disabled hidden>Version: 2.0.0</option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/master/skylark/testing.html">
                    master
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/3.2.0/skylark/testing.html">
                    3.2.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/3.1.0/skylark/testing.html">
                    3.1.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/3.0.0/skylark/testing.html">
                    3.0.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/2.2.0/skylark/testing.html">
                    2.2.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/2.1.0/skylark/testing.html">
                    2.1.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/2.0.0/skylark/testing.html">
                    2.0.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.2.0/skylark/testing.html">
                    1.2.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.1.0/skylark/testing.html">
                    1.1.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.0.0/skylark/testing.html">
                    1.0.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.29.1/skylark/testing.html">
                    0.29.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.29.0/skylark/testing.html">
                    0.29.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.28.0/skylark/testing.html">
                    0.28.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.27.0/skylark/testing.html">
                    0.27.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.26.0/skylark/testing.html">
                    0.26.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.25.0/skylark/testing.html">
                    0.25.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.24.0/skylark/testing.html">
                    0.24.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.23.0/skylark/testing.html">
                    0.23.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.22.0/skylark/testing.html">
                    0.22.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.21.0/skylark/testing.html">
                    0.21.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.20.0/skylark/testing.html">
                    0.20.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.19.2/skylark/testing.html">
                    0.19.2
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.19.1/skylark/testing.html">
                    0.19.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.18.1/skylark/testing.html">
                    0.18.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.17.2/skylark/testing.html">
                    0.17.2
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.17.1/skylark/testing.html">
                    0.17.1
                </option>
                
            </select>

            <h3>Home</h3>
            <ul class="sidebar-nav">
              <li><a href="/versions/2.0.0/bazel-overview.html">Bazel overview</a></li>
              <li><a href="/versions/2.0.0/bazel-vision.html">Bazel vision</a></li>
              <li><a href="/versions/2.0.0/getting-started.html">Getting started</a></li>
              <li><a href="/versions/2.0.0/backward-compatibility.html">Backward compatibility</a></li>
            </ul>

            <h3>Installing Bazel</h3>
            <ul class="sidebar-nav">

              <li class="sidebar-nav">
                <a href="/versions/2.0.0/install.html">Installation overview</a>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#installing-menu" aria-expanded="false"
                    aria-controls="installing-menu">
                  Installation steps<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="installing-menu">

                   <li><a href="/versions/2.0.0/install-ubuntu.html">Ubuntu</a></li>
                   <li><a href="/versions/2.0.0/install-redhat.html">Fedora/CentOS</a></li>
                   <li><a href="/versions/2.0.0/install-os-x.html">macOS</a></li>
                   <li><a href="/versions/2.0.0/install-windows.html">Windows</a></li>
                   <li><a href="/versions/2.0.0/install-compile-source.html">Compiling from source</a></li>
                   <li><a href="/versions/2.0.0/completion.html">Command-line completion</a></li>
                   <li><a href="/versions/2.0.0/ide.html">Integrating with IDEs</a></li>
                </ul>
              </li>

              
              <li class="sidebar-nav">
                <a href="/versions/2.0.0/updating-bazel.html">Updating Bazel</a>
              </li>
              
            </ul>

            <h3>Tutorials</h3>
            <ul class="sidebar-nav">
                <li><a href="/versions/2.0.0/tutorial/cpp.html">C++</a></li>
                <li><a href="/versions/2.0.0/tutorial/java.html">Java</a></li>
                <li><a href="/versions/2.0.0/tutorial/android-app.html">Android</a></li>
                <li><a href="/versions/2.0.0/tutorial/ios-app.html">iOS</a></li>
            </ul>

            <h3>Using Bazel</h3>
            <ul class="sidebar-nav">
              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#using-menu" aria-expanded="false"
                    aria-controls="using-menu">
                  Concepts<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="using-menu">
                  <li><a href="/versions/2.0.0/build-ref.html">Core concepts</a></li>
                  <li><a href="/versions/2.0.0/external.html">External dependencies</a></li>
                  <li><a href="/versions/2.0.0/configurable-attributes.html">Configurable attributes</a></li>
                  <li><a href="/versions/master/platforms-intro.html">Platforms and toolchains</a></li>
                  <li><a href="/versions/master/visibility.html">Visibility</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#guides-menu" aria-expanded="false"
                    aria-controls="build-files-menu">
                  Guides<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="guides-menu">
                  <li><a href="/versions/2.0.0/guide.html">Running Bazel</a></li>
                  <li><a href="/versions/2.0.0/skylark/tutorial-creating-a-macro.html">Creating a macro</a></li>
                  <li><a href="/versions/2.0.0/memory-saving-mode.html">Optimizing memory</a></li>
                  <li><a href="/versions/2.0.0/windows.html">Building on Windows</a></li>
                </ul>
              </li>

              
                <li><a href="/versions/2.0.0/rules.html">Rules</a></li>
              

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#query-menu" aria-expanded="false"
                    aria-controls="query-menu">
                  Queries<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="query-menu">
                  <li><a href="/versions/2.0.0/query-how-to.html">The query command</a></li>
                  <li><a href="/versions/2.0.0/cquery.html">The cquery command</a></li>
                  <li><a href="/versions/2.0.0/aquery.html">The aquery command</a></li>
                  <li><a href="/versions/2.0.0/query.html">Query language</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#best-practices-menu" aria-expanded="false"
                    aria-controls="best-practices-menu">
                  Best practices<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="best-practices-menu">
                  <li><a href="/versions/2.0.0/best-practices.html">General best practices</a></li>
                  <li><a href="/versions/2.0.0/skylark/tutorial-sharing-variables.html">Sharing BUILD variables</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#remote-execution-menu" aria-expanded="false"
                    aria-controls="remote-execution-menu">
                  Remote execution<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="remote-execution-menu">
                   <li><a href="/versions/2.0.0/remote-execution.html">Overview</a></li>
                   <li><a href="/versions/2.0.0/remote-execution-rules.html">Guidelines</a></li>
                   <li>
                      <a class="sidebar-nav-heading" data-toggle="collapse"
                          href="#troubleshoot-remote-execution-menu" aria-expanded="false"
                          aria-controls="troubleshoot-remote-execution-menu">
                        Troubleshooting<span class="caret"></span>
                      </a>
                      <ul class="collapse sidebar-nav sidebar-submenu" id="troubleshoot-remote-execution-menu">
                         <li><a href="/versions/2.0.0/remote-execution-sandbox.html">Troubleshooting with Bazel sandbox</a></li>
                         <li><a href="/versions/2.0.0/workspace-log.html">Non-hermetic WORKSPACE rules</a></li>
                         <li><a href="/versions/2.0.0/remote-execution-caching-debug.html">Debugging remote cache hits</a></li>
                      </ul>
                  </li>
                   <li><a href="/versions/2.0.0/remote-execution-ci.html">Remote execution and CI</a></li>
                 </ul>
              </li>

              <li>
                  <a class="sidebar-nav-heading" data-toggle="collapse"
                      href="#remote-caching-menu" aria-expanded="false"
                      aria-controls="remote-caching-menu">
                    Remote caching<span class="caret"></span>
                  </a>
                  <ul class="collapse sidebar-nav sidebar-submenu" id="remote-caching-menu">
                     <li><a href="/versions/2.0.0/remote-caching.html">Overview</a></li>
                     <li><a href="/versions/2.0.0/remote-caching-debug.html">Debugging remote cache hits with local execution</a></li>
                  </ul>
              </li>
              
             </ul>

           

           <h3>Reference</h3>
           <ul class="sidebar-nav">
             <li><a href="/versions/2.0.0/user-manual.html">Commands and options</a></li>
             <li><a href="/versions/2.0.0/glossary.html">Glossary</a></li>
             <li><a href="/versions/2.0.0/be/overview.html">Build encyclopedia</a></li>
             <li><a href="/versions/2.0.0/test-encyclopedia.html">Test encyclopedia</a></li>
             <li><a href="/versions/2.0.0/command-line-reference.html">Command line reference</a></li>

             <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#build-files-menu" aria-expanded="false"
                    aria-controls="build-files-menu">
                  BUILD files<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="build-files-menu">
                  <li><a href="/versions/2.0.0/be/functions.html">Functions</a></li>
                  <li><a href="/versions/2.0.0/be/common-definitions.html">Common rule definitions</a></li>
                  <li><a href="/versions/2.0.0/be/make-variables.html">"Make" variables</a></li>
                  <li><a href="/versions/2.0.0/skylark/build-style.html">BUILD style guide</a></li>
                </ul>
             </li>

             <li><a href="/versions/2.0.0/build-event-protocol.html">Build Event Protocol</a></li>
             <li><a href="/versions/2.0.0/output_directories.html">Output directory layout</a></li>
             <li><a href="/versions/2.0.0/platforms.html">Platforms</a></li>
             <li><a href="/versions/2.0.0/toolchains.html">Toolchains</a></li>
           </ul>

           <h3>Extending Bazel</h3>
           <ul class="sidebar-nav">
              <li><a href="/versions/2.0.0/skylark/concepts.html">Extension overview</a></li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#starlark-concepts" aria-expanded="false"
                    aria-controls="starlark-concepts">
                  Concepts<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="starlark-concepts">
                  <li><a href="/versions/2.0.0/skylark/macros.html">Macros</a></li>
                  <li><a href="/versions/2.0.0/skylark/rules.html">Rules</a></li>
                  <li><a href="/versions/2.0.0/skylark/depsets.html">Depsets</a></li>
                  <li><a href="/versions/2.0.0/skylark/aspects.html">Aspects</a></li>
                  <li><a href="/versions/2.0.0/skylark/repository_rules.html">Repository rules</a></li>
                  <li><a href="/versions/2.0.0/skylark/config.html">Configurations</a></li>
                </ul>
              </li>

	            <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                   href="#starlark-practices" aria-expanded="false"
                   aria-controls="starlark-practices">
                  Best practices<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="starlark-practices">
                  <li><a href="/versions/2.0.0/skylark/bzl-style.html">.bzl style guide</a></li>
                  <li><a href="/versions/2.0.0/skylark/testing.html">Testing extensions</a></li>
                  <li><a href="https://github.com/bazelbuild/stardoc">Documenting rules with Stardoc</a></li>
                  <li><a href="https://github.com/bazelbuild/buildtools/tree/master/buildifier">Linting</a></li>
                  <li><a href="/versions/2.0.0/skylark/performance.html">Optimizing performance</a></li>
                  <li><a href="/versions/2.0.0/skylark/deploying.html">Deploying rules</a></li>
                  <li><a href="/versions/2.0.0/skylark/windows_tips.html">Writing rules on Windows</a></li>
                </ul>
              </li>

              <li><a href="https://github.com/bazelbuild/examples/tree/master/rules">Examples</a></li>
              <li><a href="/versions/2.0.0/skylark/lib/skylark-overview.html">Extensions API</a></li>
              <li><a href="/versions/2.0.0/skylark/faq.html">FAQ</a></li>
              <li><a href="/versions/2.0.0/skylark/language.html">Starlark language</a></li>
            </ul>
          </nav>
        </div>

        <div class="col-md-8">
          <div class="content">
            <h1 id="testing">Testing</h1>

<p>There are several different approaches to testing Starlark code in Bazel. This
page gathers the current best practices and frameworks by use case.</p>

<ul id="markdown-toc">
  <li><a href="#for-testing-rules" id="markdown-toc-for-testing-rules">For testing rules</a>    <ul>
      <li><a href="#minimal-example" id="markdown-toc-minimal-example">Minimal example</a></li>
      <li><a href="#failure-testing" id="markdown-toc-failure-testing">Failure Testing</a></li>
      <li><a href="#verifying-registered-actions" id="markdown-toc-verifying-registered-actions">Verifying Registered Actions</a></li>
      <li><a href="#verifying-rule-behavior-under-different-flags" id="markdown-toc-verifying-rule-behavior-under-different-flags">Verifying Rule Behavior Under Different Flags</a></li>
    </ul>
  </li>
  <li><a href="#for-validating-artifacts" id="markdown-toc-for-validating-artifacts">For validating artifacts</a>    <ul>
      <li><a href="#using-a-test-target" id="markdown-toc-using-a-test-target">Using a test target</a></li>
      <li><a href="#using-a-custom-rule" id="markdown-toc-using-a-custom-rule">Using a custom rule</a></li>
    </ul>
  </li>
  <li><a href="#for-testing-starlark-utilities" id="markdown-toc-for-testing-starlark-utilities">For testing Starlark utilities</a></li>
</ul>

<h2 id="for-testing-rules">For testing rules</h2>

<p><a href="https://github.com/bazelbuild/bazel-skylib">Skylib</a> has a test framework called
<a href="https://github.com/bazelbuild/bazel-skylib/blob/master/lib/unittest.bzl"><code class="highlighter-rouge">unittest.bzl</code></a>
for checking the analysis-time behavior of rules, such as their actions and
providers. Such tests are called “analysis tests” and are currently the best
option for testing the inner workings of rules.</p>

<p>Some caveats:</p>

<ul>
  <li>
    <p>Test assertions occur within the build, not a separate test runner process.
Targets that are created by the test must be named such that they do not
collide with targets from other tests or from the build. An error that
occurs during the test is seen by Bazel as a build breakage rather than a
test failure.</p>
  </li>
  <li>
    <p>It requires a fair amount of boilerplate to set up the rules under test and
the rules containing test assertions. This boilerplate may seem daunting at
first. It helps to <a href="concepts.html#evaluation-model">keep in mind</a> that macros
are evaluated and targets generated during the loading phase, while rule
implementation functions don’t run until later, during the analysis phase.</p>
  </li>
  <li>
    <p>Analysis tests are intended to be fairly small and lightweight. Certain
features of the analysis testing framework are restricted to verifying
targets with a maximum number of transitive dependencies (currently 500).
This is due to performance implications of using these features with larger
tests.</p>
  </li>
</ul>

<p>The basic principle is to define a testing rule that depends on the
rule-under-test. This gives the testing rule access to the rule-under-test’s
providers.</p>

<p>The testing rule’s implementation function carries out assertions. If there are
any failures, these are not raised immediately by calling <code class="highlighter-rouge">fail()</code> (which would
trigger an analysis-time build error), but rather by storing the errors in a
generated script that fails at test execution time.</p>

<p>See below for a minimal toy example, followed by an example that checks actions.</p>

<h3 id="minimal-example">Minimal example</h3>

<p><code class="highlighter-rouge">//mypkg/myrules.bzl</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MyInfo</span> <span class="o">=</span> <span class="n">provider</span><span class="p">(</span><span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"val"</span><span class="p">:</span> <span class="s">"string value"</span><span class="p">,</span>
    <span class="s">"out"</span><span class="p">:</span> <span class="s">"output File"</span><span class="p">,</span>
<span class="p">})</span>

<span class="k">def</span> <span class="nf">_myrule_impl</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="s">"""Rule that just generates a file and returns a provider."""</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">declare_file</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">".out"</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s">"abc"</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">MyInfo</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s">"some value"</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)]</span>

<span class="n">myrule</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span>
    <span class="n">implementation</span> <span class="o">=</span> <span class="n">_myrule_impl</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">//mypkg/myrules_test.bzl</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@bazel_skylib//lib:unittest.bzl"</span><span class="p">,</span> <span class="s">"asserts"</span><span class="p">,</span> <span class="s">"analysistest"</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">":myrules.bzl"</span><span class="p">,</span> <span class="s">"myrule"</span><span class="p">,</span> <span class="s">"MyInfo"</span><span class="p">)</span>

<span class="c1"># ==== Check the provider contents ====
</span>
<span class="k">def</span> <span class="nf">_provider_contents_test_impl</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

    <span class="n">target_under_test</span> <span class="o">=</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">target_under_test</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="c1"># If preferred, could pass these values as "expected" and "actual" keyword
</span>    <span class="c1"># arguments.
</span>    <span class="n">asserts</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"some value"</span><span class="p">,</span> <span class="n">target_under_test</span><span class="p">[</span><span class="n">MyInfo</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>

    <span class="c1"># If you forget to return end(), you will get an error about an analysis
</span>    <span class="c1"># test needing to return an instance of AnalysisTestResultInfo.
</span>    <span class="k">return</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="c1"># Create the testing rule to wrap the test logic. This must be bound to a global
# variable, not called in a macro's body, since macros get evaluated at loading
# time but the rule gets evaluated later, at analysis time. Since this is a test
# rule, its name must end with "_test".
</span><span class="n">provider_contents_test</span> <span class="o">=</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">_provider_contents_test_impl</span><span class="p">)</span>

<span class="c1"># Macro to setup the test.
</span><span class="k">def</span> <span class="nf">_test_provider_contents</span><span class="p">():</span>
    <span class="c1"># Rule under test. Be sure to tag 'manual', as this target should not be
</span>    <span class="c1"># built using `:all` except as a dependency of the test.
</span>    <span class="n">myrule</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"provider_contents_subject"</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s">"manual"</span><span class="p">])</span>
    <span class="c1"># Testing rule.
</span>    <span class="n">provider_contents_test</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"provider_contents_test"</span><span class="p">,</span>
                           <span class="n">target_under_test</span> <span class="o">=</span> <span class="s">":provider_contents_subject"</span><span class="p">)</span>
    <span class="c1"># Note the target_under_test attribute is how the test rule depends on
</span>    <span class="c1"># the real rule target.
</span>
<span class="c1"># Entry point from the BUILD file; macro for running each test case's macro and
# declaring a test suite that wraps them together.
</span><span class="k">def</span> <span class="nf">myrules_test_suite</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="c1"># Call all test functions and wrap their targets in a suite.
</span>    <span class="n">_test_provider_contents</span><span class="p">()</span>
    <span class="c1"># ...
</span>
    <span class="n">native</span><span class="o">.</span><span class="n">test_suite</span><span class="p">(</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">":provider_contents_test"</span><span class="p">,</span>
            <span class="c1"># ...
</span>        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">//mypkg/BUILD</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">":myrules.bzl"</span><span class="p">,</span> <span class="s">"myrule"</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">":myrules_test.bzl"</span><span class="p">,</span> <span class="s">"myrules_test_suite"</span><span class="p">)</span>

<span class="c1"># Production use of the rule.
</span><span class="n">myrule</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"mytarget"</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Call a macro that defines targets that perform the tests at analysis time,
# and that can be executed with "bazel test" to return the result.
</span><span class="n">myrules_test_suite</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"myrules_tests"</span><span class="p">)</span>
</code></pre></div></div>

<p>The test can be run with <code class="highlighter-rouge">bazel test //mypkg:myrules_test</code>.</p>

<p>Aside from the initial <code class="highlighter-rouge">load()</code> statements, there are two main parts to the
file:</p>

<ul>
  <li>
    <p>The tests themselves, each of which consists of 1) an analysis-time
implementation function for the testing rule, 2) a declaration of the
testing rule via <code class="highlighter-rouge">analysistest.make()</code>, and 3) a loading-time function
(macro) for declaring the rule-under-test (and its dependencies) and testing
rule. If the assertions do not change between test cases, 1) and 2) may be
shared by multiple test cases.</p>
  </li>
  <li>
    <p>The test suite function, which calls the loading-time functions for each
test, and declares a <code class="highlighter-rouge">test_suite</code> target bundling all tests together.</p>
  </li>
</ul>

<p>We recommend the following naming convention. Let <code class="highlighter-rouge">foo</code> stand for the part of
the test name that describes what the test is checking (<code class="highlighter-rouge">provider_contents</code> in
the above example). For example, a JUnit test method would be named <code class="highlighter-rouge">testFoo</code>.
Then:</p>

<ul>
  <li>
    <p>the macro which generates the test and target under test should should be
named <code class="highlighter-rouge">_test_foo</code> (<code class="highlighter-rouge">_test_provider_contents</code>)</p>
  </li>
  <li>
    <p>its test rule type should be named <code class="highlighter-rouge">foo_test</code> (<code class="highlighter-rouge">provider_contents_test</code>)</p>
  </li>
  <li>
    <p>the label of the target of this rule type should be <code class="highlighter-rouge">foo</code>
(<code class="highlighter-rouge">provider_contents_test</code>)</p>
  </li>
  <li>
    <p>the implementation function for the testing rule should be named
<code class="highlighter-rouge">_foo_test_impl</code> (<code class="highlighter-rouge">_provider_contents_test_impl</code>)</p>
  </li>
  <li>
    <p>the labels of the targets of the rules under test and their dependencies
should be prefixed with <code class="highlighter-rouge">foo_</code> (<code class="highlighter-rouge">provider_contents_</code>)</p>
  </li>
</ul>

<p>Note that the labels of all targets can conflict with other labels in the same
BUILD package, so it’s helpful to use a unique name for the test.</p>

<h3 id="failure-testing">Failure Testing</h3>

<p>It may be useful to verify that a rule fails given certain inputs or in certain
state. This can be done using the analysis test framework:</p>

<p>The test rule created with <code class="highlighter-rouge">analysistest.make</code> should specify <code class="highlighter-rouge">expect_failure</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">failure_testing_test</span> <span class="o">=</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">make</span><span class="p">(</span>
    <span class="n">_failure_testing_test_impl</span><span class="p">,</span>
    <span class="n">expect_failure</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>The test rule implementation should make assertions on the nature of the failure
that took place (specifically, the failure message):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_failure_testing_test_impl</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
    <span class="n">asserts</span><span class="o">.</span><span class="n">expect_failure</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"This rule should never work"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</code></pre></div></div>

<p>Also make sure that your target under test is specifically tagged ‘manual’.
Without this, building all targets in your package using <code class="highlighter-rouge">:all</code> will result in a
build of the intentionally-failing target and will exhibit a build failure. With
‘manual’, your target under test will build only if explicitly specified, or as
a dependency of a non-manual target (such as your test rule):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_test_failure</span><span class="p">():</span>
    <span class="n">myrule</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"this_should_fail"</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s">"manual"</span><span class="p">])</span>

    <span class="n">failure_testing_test</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"failure_testing_test"</span><span class="p">,</span>
                         <span class="n">target_under_test</span> <span class="o">=</span> <span class="s">":this_should_fail"</span><span class="p">)</span>

<span class="c1"># Then call _test_failure() in the macro which generates the test suite and add
# ":failure_testing_test" to the suite's test targets.
</span></code></pre></div></div>

<h3 id="verifying-registered-actions">Verifying Registered Actions</h3>

<p>You may want to write tests which make assertions about the actions that your
rule registers, for example, using <code class="highlighter-rouge">ctx.actions.run()</code>. This can be done in your
analysis test rule implementation function. An example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_inspect_actions_test_impl</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

    <span class="n">target_under_test</span> <span class="o">=</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">target_under_test</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">target_actions</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">asserts</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">))</span>
    <span class="n">action_output</span> <span class="o">=</span> <span class="n">actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span> <span class="n">target_under_test</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">".out"</span><span class="p">,</span> <span class="n">action_output</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</code></pre></div></div>

<p>Note that <code class="highlighter-rouge">analysistest.target_actions(env)</code> returns a list of
<a href="lib/Action.html"><code class="highlighter-rouge">Action</code></a> objects which represent actions registered by the
target under test.</p>

<h3 id="verifying-rule-behavior-under-different-flags">Verifying Rule Behavior Under Different Flags</h3>

<p>You may want to verify your real rule behaves a certain way given certain build
flags. For example, your rule may behave differently if a user specifies:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel build //mypkg:real_target <span class="nt">-c</span> opt
</code></pre></div></div>

<p>versus</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel build //mypkg:real_target <span class="nt">-c</span> dbg
</code></pre></div></div>

<p>At first glance, this could be done by testing the target under test using the
desired build flags:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel <span class="nb">test</span> //mypkg:myrules_test <span class="nt">-c</span> opt
</code></pre></div></div>

<p>But then it becomes impossible for your test suite to simultaneously contain a
test which verifies the rule behavior under <code class="highlighter-rouge">-c opt</code> and another test which
verifies the rule behavior under <code class="highlighter-rouge">-c dbg</code>. Both tests would not be able to run
in the same build!</p>

<p>This can be solved by specifying the desired build flags when defining the test
rule:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">myrule_c_opt_test</span> <span class="o">=</span> <span class="n">analysistest</span><span class="o">.</span><span class="n">make</span><span class="p">(</span>
    <span class="n">_myrule_c_opt_test_impl</span><span class="p">,</span>
    <span class="n">config_settings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"//command_line_option:compilation_mode"</span><span class="p">:</span> <span class="s">"opt"</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Normally, a target under test is analyzed given the current build flags.
Specifying <code class="highlighter-rouge">config_settings</code> overrides the values of the specified command line
options. (Any unspecified options will retain their values from the actual
command line).</p>

<p>In the specified <code class="highlighter-rouge">config_settings</code> dictionary, command line flags must be
prefixed with a special placeholder value <code class="highlighter-rouge">//command_line_option:</code>, as is shown
above.</p>

<h2 id="for-validating-artifacts">For validating artifacts</h2>

<p>There are two main ways of checking that your generated files are correct: You
can write a test script in shell, Python, or another language, and create a
target of the appropriate <code class="highlighter-rouge">*_test</code> rule type; or you can use a specialized rule
for the kind of test you want to perform.</p>

<h3 id="using-a-test-target">Using a test target</h3>

<p>The most straightforward way to validate an artifact is to write a script and
add a <code class="highlighter-rouge">*_test</code> target to your BUILD file. The specific artifacts you want to
check should be data dependencies of this target. If your validation logic is
reusable for multiple tests, it should be a script that takes command line
arguments that are controlled by the test target’s <code class="highlighter-rouge">args</code> attribute. Here’s an
example that validates that the output of <code class="highlighter-rouge">myrule</code> from above is <code class="highlighter-rouge">"abc"</code>.</p>

<p><code class="highlighter-rouge">//mypkg/myrule_validator.sh</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> <span class="nv">$1</span><span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"abc"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Passed"</span>
  <span class="nb">exit </span>0
<span class="k">else
  </span><span class="nb">echo</span> <span class="s2">"Failed"</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">//mypkg/BUILD</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>

<span class="n">myrule</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"mytarget"</span><span class="p">,</span>
<span class="p">)</span>

<span class="o">...</span>

<span class="c1"># Needed for each target whose artifacts are to be checked.
</span><span class="n">sh_test</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"validate_mytarget"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">":myrule_validator.sh"</span><span class="p">],</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">"$(location :mytarget.out)"</span><span class="p">],</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="s">":mytarget.out"</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div>

<h3 id="using-a-custom-rule">Using a custom rule</h3>

<p>A more complicated alternative is to write the shell script as a template that
gets instantiated by a new rule. This involves more indirection and Starlark
logic, but leads to cleaner BUILD files. As a side-benefit, any argument
preprocessing can be done in Starlark instead of the script, and the script is
slightly more self-documenting since it uses symbolic placeholders (for
substitutions) instead of numeric ones (for arguments).</p>

<p><code class="highlighter-rouge">//mypkg/myrule_validator.sh.template</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> %TARGET%<span class="si">)</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"abc"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Passed"</span>
  <span class="nb">exit </span>0
<span class="k">else
  </span><span class="nb">echo</span> <span class="s2">"Failed"</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">//mypkg/myrule_validation.bzl</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_myrule_validation_test_impl</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
  <span class="s">"""Rule for instantiating myrule_validator.sh.template for a given target."""</span>
  <span class="n">exe</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">executable</span>
  <span class="n">target</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="nb">file</span><span class="o">.</span><span class="n">target</span>
  <span class="n">ctx</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">expand_template</span><span class="p">(</span><span class="n">output</span> <span class="o">=</span> <span class="n">exe</span><span class="p">,</span>
                              <span class="n">template</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="nb">file</span><span class="o">.</span><span class="n">_script</span><span class="p">,</span>
                              <span class="n">is_executable</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                              <span class="n">substitutions</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s">"</span><span class="si">%</span><span class="s">TARGET</span><span class="si">%</span><span class="s">"</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">short_path</span><span class="p">,</span>
                              <span class="p">})</span>
  <span class="c1"># This is needed to make sure the output file of myrule is visible to the
</span>  <span class="c1"># resulting instantiated script.
</span>  <span class="k">return</span> <span class="p">[</span><span class="n">DefaultInfo</span><span class="p">(</span><span class="n">runfiles</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">runfiles</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">]))]</span>

<span class="n">myrule_validation_test</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span>
    <span class="n">implementation</span> <span class="o">=</span> <span class="n">_myrule_validation_test_impl</span><span class="p">,</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s">"target"</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">allow_single_file</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
             <span class="c1"># We need an implicit dependency in order to access the template.
</span>             <span class="c1"># A target could potentially override this attribute to modify
</span>             <span class="c1"># the test logic.
</span>             <span class="s">"_script"</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">allow_single_file</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                   <span class="n">default</span><span class="o">=</span><span class="n">Label</span><span class="p">(</span><span class="s">"//mypkg:myrule_validator"</span><span class="p">))},</span>
    <span class="n">test</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">//mypkg/BUILD</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>

<span class="n">myrule</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"mytarget"</span><span class="p">,</span>
<span class="p">)</span>

<span class="o">...</span>

<span class="c1"># Needed just once, to expose the template. Could have also used export_files(),
# and made the _script attribute set allow_files=True.
</span><span class="n">filegroup</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"myrule_validator"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">":myrule_validator.sh.template"</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># Needed for each target whose artifacts are to be checked. Notice that we no
# longer have to specify the output file name in a data attribute, or its
# $(location) expansion in an args attribute, or the label for the script
# (unless we want to override it).
</span><span class="n">myrule_validation_test</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"validate_mytarget"</span><span class="p">,</span>
    <span class="n">target</span> <span class="o">=</span> <span class="s">":mytarget"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Alternatively, instead of using a template expansion action, we could have
inlined the template into the .bzl file as a string and expanded it during the
analysis phase using the <code class="highlighter-rouge">str.format</code> method or <code class="highlighter-rouge">%</code>-formatting.</p>

<h2 id="for-testing-starlark-utilities">For testing Starlark utilities</h2>

<p><a href="https://github.com/bazelbuild/bazel-skylib">Skylib</a>’s
<a href="https://github.com/bazelbuild/bazel-skylib/blob/master/lib/unittest.bzl"><code class="highlighter-rouge">unittest.bzl</code></a>
framework can be used to test utility functions (that is, functions that are
neither macros nor rule implementations). Instead of using <code class="highlighter-rouge">unittest.bzl</code>’s
<code class="highlighter-rouge">analysistest</code> library, <code class="highlighter-rouge">unittest</code> may be used. For such test suites, the
convenience function <code class="highlighter-rouge">unittest.suite()</code> can be used to reduce boilerplate.</p>

<p><code class="highlighter-rouge">//mypkg/myhelpers.bzl</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">myhelper</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">"abc"</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">//mypkg/myhelpers_test.bzl</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@bazel_skylib//lib:unittest.bzl"</span><span class="p">,</span> <span class="s">"asserts"</span><span class="p">,</span> <span class="s">"unittest"</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">":myhelpers.bzl"</span><span class="p">,</span> <span class="s">"myhelper"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_myhelper_test_impl</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
  <span class="n">env</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
  <span class="n">asserts</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"abc"</span><span class="p">,</span> <span class="n">myhelper</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="n">myhelper_test</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">_myhelper_test_impl</span><span class="p">)</span>

<span class="c1"># No need for a test_myhelper() setup function.
</span>
<span class="k">def</span> <span class="nf">myhelpers_test_suite</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
  <span class="c1"># unittest.suite() takes care of instantiating the testing rules and creating
</span>  <span class="c1"># a test_suite.
</span>  <span class="n">unittest</span><span class="o">.</span><span class="n">suite</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">myhelper_test</span><span class="p">,</span>
    <span class="c1"># ...
</span>  <span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">//mypkg/BUILD</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">":myhelpers_test.bzl"</span><span class="p">,</span> <span class="s">"myhelpers_test_suite"</span><span class="p">)</span>

<span class="n">myhelpers_test_suite</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"myhelpers_tests"</span><span class="p">)</span>
</code></pre></div></div>

<p>For more examples, see Skylib’s own <a href="https://github.com/bazelbuild/bazel-skylib/blob/master/tests/BUILD">tests</a>.</p>

          </div>
        </div>

        <div class="col-md-2 sticky-sidebar">
            <div class="right-sidebar">
                <ul class="gh-links">
                    <li><a href="https://github.com/bazelbuild/bazel/issues/new?title=Documentation issue: Testing&body=Documentation URL: https://docs.bazel.build/versions/2.0.0/skylark/testing.html&labels=type: documentation"><i class="fa fa-github"></i> Create issue</a></li>
                    <li id="gh-edit-list-item" class="default-hidden" aria-hidden="true"><a id="gh-edit" class="gh-edit default-hidden"><i class="fa fa-pencil" aria-hidden="true"></i> Edit this page</a></li>
                </ul>
                <script>
                 var versionDocsURLRegex = /\/versions\/[\w\.]+\/(.*)/;
                 var ghDocsBazeURL = 'https://github.com/bazelbuild/bazel/tree/master/site/docs/';
                 var editButton = document.getElementById('gh-edit');
                 var editButtonListItem = document.getElementById('gh-edit-list-item');
                 // if there is an edit button and we are not in the Build Encyclopedia
                 // or other generated files.
                 if (editButton
                     && window.location.pathname.match(versionDocsURLRegex)
                     && window.location.pathname.lastIndexOf('/be/') == -1
                     && window.location.pathname.lastIndexOf('/repo/') == -1
                     && window.location.pathname.lastIndexOf('/skylark/lib/') == -1
                     && window.location.pathname.lastIndexOf('/command-line-reference.html') == -1) {
                     var docFile = window.location.pathname.match(versionDocsURLRegex)[1];
                     // some pages are not using markdown :(
                     if (docFile !== 'user-manual.html'
                         && docFile !== 'build-ref.html'
                         && docFile !== 'query.html'
                         && docFile !== 'test-encyclopedia.html') {
                         docFile = docFile.replace('html', 'md');
                     }
                     editButton.href = ghDocsBazeURL + docFile;
                     editButton.style.visibility = 'visible';
                     editButtonListItem.style.visibility = 'visible';
                 }
                </script>

                <ul class="page-toc">
<li class="toc-entry toc-h2"><a href="#for-testing-rules">For testing rules</a>
<ul class="page-toc-sublist">
<li class="toc-entry toc-h3"><a href="#minimal-example">Minimal example</a></li>
<li class="toc-entry toc-h3"><a href="#failure-testing">Failure Testing</a></li>
<li class="toc-entry toc-h3"><a href="#verifying-registered-actions">Verifying Registered Actions</a></li>
<li class="toc-entry toc-h3"><a href="#verifying-rule-behavior-under-different-flags">Verifying Rule Behavior Under Different Flags</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#for-validating-artifacts">For validating artifacts</a>
<ul class="page-toc-sublist">
<li class="toc-entry toc-h3"><a href="#using-a-test-target">Using a test target</a></li>
<li class="toc-entry toc-h3"><a href="#using-a-custom-rule">Using a custom rule</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#for-testing-starlark-utilities">For testing Starlark utilities</a></li>
</ul>
            </div>
        </div>
      </div>
    </div>

    <!-- Satisfaction Survey -->
    <script async="" defer="" src="//www.google.com/insights/consumersurveys/async_survey?site=hihwpyy5e5kllsq62elzjrcgn4"></script>

        <footer class="footer">
      <div class="container">
  <div class="row">
    <div class="col-sm-4 col-md-2">
      <p>About</p>
      <ul class="list-unstyled">
        <li><a href="https://github.com/bazelbuild/bazel/wiki/Bazel-Users">Who's Using Bazel?</a></li>
        <li><a href="https://www.bazel.build/roadmap.html">Roadmap</a></li>
        <li><a href="https://www.bazel.build/contributing.html">Contribute</a></li>
        <li><a href="https://www.bazel.build/governance.html">Governance Plan</a></li>
        <li><a href="https://policies.google.com/privacy">Privacy Policy</a></li>
        <li><a href="//sitemap.xml">Sitemap</a></li>
      </ul>
    </div>
    <div class="col-sm-4 col-md-2">
      <p>Support</p>
      <ul class="list-unstyled">
        <li><a href="http://stackoverflow.com/questions/tagged/bazel">Stack Overflow</a></li>
        <li><a href="https://github.com/bazelbuild/bazel/issues">Issue Tracker</a></li>
        <li><a href="/">Documentation</a></li>
        <li><a href="https://www.bazel.build/faq.html">FAQ</a></li>
        <li><a href="https://www.bazel.build/support.html">Support Policy</a></li>
      </ul>
    </div>
    <div class="col-sm-4 col-md-2">
      <p>Stay Connected</p>
      <ul class="list-unstyled">
        <li><a href="https://twitter.com/bazelbuild">Twitter</a></li>
        <li><a href="https://blog.bazel.build">Blog</a></li>
        <li><a href="https://github.com/bazelbuild/bazel">GitHub</a></li>
        <li><a href="https://groups.google.com/forum/#!forum/bazel-discuss">Discussion group</a></li>
        <li><a href="https://slack.bazel.build">Slack</a></li>
      </ul>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <p class="text-muted">&copy; 2020 Google</p>
    </div>
  </div>
</div>

    </footer>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/assets/js/bootstrap.min.js"></script>

    <!-- Anchor JS -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>
    <script>
      // Automatically add anchors and links to all header elements that don't already have them.
      anchors.add();
    </script>

    <script>
      var shiftWindow = function() {
        if (location.hash.length !== 0) {
          window.scrollBy(0, -50);
        }
      };
      window.addEventListener("hashchange", shiftWindow);

      var highlightCurrentSidebarNav = function() {
        var href = location.pathname;
        var item = $('#sidebar-nav [href$="' + href + '"]');
        if (item) {
          var li = item.parent();
          li.addClass("active");

          if (li.parent() && li.parent().is("ul")) {
            do {
              var ul = li.parent();
              if (ul.hasClass("collapse")) {
                ul.collapse("show");
              }
              li = ul.parent();
            } while (li && li.is("li"));
          }
        }
      };

      $(document).ready(function() {
        // Scroll to anchor of location hash, adjusted for fixed navbar.
        window.setTimeout(function() {
          shiftWindow();
        }, 1);

        // Flip the caret when submenu toggles are clicked.
        $(".sidebar-submenu").on("show.bs.collapse", function() {
          var toggle = $('[href$="#' + $(this).attr('id') + '"]');
          if (toggle) {
            toggle.addClass("dropup");
          }
        });
        $(".sidebar-submenu").on("hide.bs.collapse", function() {
          var toggle = $('[href$="#' + $(this).attr('id') + '"]');
          if (toggle) {
            toggle.removeClass("dropup");
          }
        });

        // Highlight the current page on the sidebar nav.
        highlightCurrentSidebarNav();
      });
    </script>

    <!-- Google Analytics tracking code -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-61082125-1', 'auto');
      ga('send', 'pageview');
    </script>

  </body>
</html>

