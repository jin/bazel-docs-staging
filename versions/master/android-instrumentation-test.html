<!-- /versions/master/foo/bar -> ["master", "foo", "bar"] -->
<!-- /versions/0.12.3/baz.md -> ["0.12.3", "baz.md"] -->





<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Only show Bazel version in title if it's a release -->
    <title>Android Instrumentation Tests - Bazel </title>

    <link rel="canonical" href="/versions/master/android-instrumentation-test.html">

    <!-- Webfont -->
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,500,700|Open+Sans:400,600,700,800" rel="stylesheet">

    <link rel="shortcut icon" type="image/png" href="/images/favicon.ico">

    <!-- Bootstrap -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/font-awesome.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom stylesheet -->
    <link rel="stylesheet" type="text/css" href="/css/main.css" />

    <!-- metadata -->
    <meta name="og:title" content="Android Instrumentation Tests"/>
    <meta name="og:image" content="/images/bazel-og-image.png"/>

    <!-- google search console verification -->
    <meta name="google-site-verification" content="ftWLOiP2hnDW4Cw3LUGEaXU83RVIpiyxwaXFFhoakzs" />
  </head>

  <body>
        <nav id="common-nav" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://www.bazel.build/">
            <img class="navbar-logo" src="/images/bazel-navbar.svg">
          </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/bazelbuild/bazel">GitHub</a></li>
          </ul>
          <form class="navbar-form navbar-right" action="/search.html" id="cse-search-box">
            <div class="form-group">
              <input type="hidden" name="cx" value="009927877080525621790:2pxlpaexqpc">
              <input type="hidden" name="cof" value="FORID:10">
              <input type="hidden" name="ie" value="UTF-8">
              <input type="search" name="q" id="q" class="form-control input-sm" placeholder="Search">
            </div>
          </form>
          <ul class="nav navbar-nav navbar-right">
            <li>
              <a href="/">Documentation</a>
            </li>
            <li>
              <a href="https://www.bazel.build/contributing.html">Contribute</a>
            </li>
            <li>
              <a href="https://blog.bazel.build">Blog</a>
            </li>
            <li><a href="https://twitter.com/bazelbuild" class="nav-icon"><i class="fa fa-twitter"></i></a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/bazel" class="nav-icon"><i class="fa fa-stack-overflow"></i></a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>


    <div class="container vpad">
      <div class="row">
        <div class="col-md-2">
          <a class="btn btn-default btn-lg btn-block sidebar-toggle"
              data-toggle="collapse" href="#sidebar-nav" aria-expanded="false"
              aria-controls="sidebar-nav">
            <i class="glyphicon glyphicon-menu-hamburger"></i> Navigation
          </a>

          <nav class="sidebar collapse" id="sidebar-nav">
            <select onchange="location.href=this.value">
                <option value="" selected disabled hidden>Version: master</option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/master/android-instrumentation-test.html">
                    master
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/2.1.0/android-instrumentation-test.html">
                    2.1.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/2.0.0/android-instrumentation-test.html">
                    2.0.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.2.0/android-instrumentation-test.html">
                    1.2.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.1.0/android-instrumentation-test.html">
                    1.1.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.0.0/android-instrumentation-test.html">
                    1.0.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.29.1/android-instrumentation-test.html">
                    0.29.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.29.0/android-instrumentation-test.html">
                    0.29.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.28.0/android-instrumentation-test.html">
                    0.28.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.27.0/android-instrumentation-test.html">
                    0.27.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.26.0/android-instrumentation-test.html">
                    0.26.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.25.0/android-instrumentation-test.html">
                    0.25.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.24.0/android-instrumentation-test.html">
                    0.24.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.23.0/android-instrumentation-test.html">
                    0.23.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.22.0/android-instrumentation-test.html">
                    0.22.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.21.0/android-instrumentation-test.html">
                    0.21.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.20.0/android-instrumentation-test.html">
                    0.20.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.19.2/android-instrumentation-test.html">
                    0.19.2
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.19.1/android-instrumentation-test.html">
                    0.19.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.18.1/android-instrumentation-test.html">
                    0.18.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.17.2/android-instrumentation-test.html">
                    0.17.2
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.17.1/android-instrumentation-test.html">
                    0.17.1
                </option>
                
            </select>

            <h4>Home</h4>
            <ul class="sidebar-nav">
              <li><a href="/versions/master/bazel-overview.html">Bazel Overview</a></li>
              <li><a href="/versions/master/bazel-vision.html">Bazel Vision</a></li>
              <li><a href="/versions/master/getting-started.html">Getting Started</a></li>
              <li><a href="/versions/master/backward-compatibility.html">Backward Compatibility</a></li>
            </ul>

            <h4>Installing and Using Bazel</h4>
            <ul class="sidebar-nav">

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#installing-menu" aria-expanded="false"
                    aria-controls="installing-menu">
                  Installing Bazel<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="installing-menu">
                   <li><a href="/versions/master/install.html">Installation Overview</a></li>
                   <li><a href="/versions/master/install-ubuntu.html">Installing on Ubuntu</a></li>
                   <li><a href="/versions/master/install-redhat.html">Installing on Fedora/CentOS</a></li>
                   <li><a href="/versions/master/install-os-x.html">Installing on macOS</a></li>
                   <li><a href="/versions/master/install-windows.html">Installing on Windows</a></li>
                   <li><a href="/versions/master/install-compile-source.html">Compiling from Source</a></li>
                   <li><a href="/versions/master/completion.html">Command-Line Completion</a></li>
                   <li><a href="/versions/master/ide.html">Integrating with IDEs</a></li>
                </ul>
              </li>

              
              <li class="sidebar-nav">
                <a href="/versions/master/updating-bazel.html">Updating Bazel</a>
              </li>
              

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#using-menu" aria-expanded="false"
                    aria-controls="using-menu">
                  Using Bazel<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="using-menu">
                  <li><a href="/versions/master/build-ref.html">Bazel Concepts</a></li>
                  <li><a href="/versions/master/guide.html">User's Guide (Bazel commands)</a></li>
                  <li><a href="/versions/master/external.html">External Dependencies</a></li>
                  <li><a href="/versions/master/configurable-attributes.html">Configurable Attributes</a></li>
                  <li><a href="/versions/master/best-practices.html">Best Practices</a></li>
                  <li><a href="/versions/master/memory-saving-mode.html">Memory-saving Mode</a></li>
                  <li><a href="/versions/master/windows.html">Using Bazel on Windows</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#build-files-menu" aria-expanded="false"
                    aria-controls="build-files-menu">
                  BUILD files<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="build-files-menu">
                  <li><a href="/versions/master/be/functions.html">Functions</a></li>
                  <li><a href="/versions/master/be/common-definitions.html">Common Definitions</a></li>
                  <li><a href="/versions/master/be/make-variables.html">"Make" Variables</a></li>
                  <li><a href="/versions/master/skylark/tutorial-sharing-variables.html">Sharing Variables</a></li>
                  <li><a href="/versions/master/skylark/tutorial-creating-a-macro.html">Creating a Macro</a></li>
                </ul>
              </li>

              
                <li><a href="/versions/master/rules.html">Rules</a></li>
              

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#query-menu" aria-expanded="false"
                    aria-controls="query-menu">
                  Queries<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="query-menu">
                  <li><a href="/versions/master/query-how-to.html">Bazel query</a></li>
                  <li><a href="/versions/master/cquery.html">Bazel cquery</a></li>
                  <li><a href="/versions/master/aquery.html">Bazel aquery</a></li>
                  <li><a href="/versions/master/query.html">Query Language</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#remote-execution-menu" aria-expanded="false"
                    aria-controls="remote-execution-menu">
                  Remote Execution<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="remote-execution-menu">
                   <li><a href="/versions/master/remote-execution.html">Remote Execution Overview</a></li>
                   <li><a href="/versions/master/remote-execution-rules.html">Guidelines for Remote Execution</a></li>
                   <li>
                      <a class="sidebar-nav-heading" data-toggle="collapse"
                          href="#troubleshoot-remote-execution-menu" aria-expanded="false"
                          aria-controls="troubleshoot-remote-execution-menu">
                        Troubleshooting Remote Execution<span class="caret"></span>
                      </a>
                      <ul class="collapse sidebar-nav sidebar-submenu" id="troubleshoot-remote-execution-menu">
                         <li><a href="/versions/master/remote-execution-sandbox.html">Troubleshooting Remote Execution with Bazel Sandbox</a></li>
                         <li><a href="/versions/master/workspace-log.html">Finding non-hermetic behavior in WORKSPACE rules</a></li>
                         <li><a href="/versions/master/remote-execution-caching-debug.html">Debugging Remote Cache Hit Rate</a></li>
                      </ul>
                  </li>
                   <li><a href="/versions/master/remote-execution-ci.html">Configuring Bazel CI for Remote Execution Rule Testing</a></li>
                 </ul>
              </li>

              <li>
                  <a class="sidebar-nav-heading" data-toggle="collapse"
                      href="#remote-caching-menu" aria-expanded="false"
                      aria-controls="remote-caching-menu">
                    Remote Caching<span class="caret"></span>
                  </a>
                  <ul class="collapse sidebar-nav sidebar-submenu" id="remote-caching-menu">
                     <li><a href="/versions/master/remote-caching.html">Remote Caching Overview</a></li>
                     <li><a href="/versions/master/remote-caching-debug.html">Debugging Remote Cache Hit Rate for Local Execution</a></li>
                  </ul>
              </li>
              
              <li><a href="/versions/master/platforms-intro.html">Building With Platforms</a></li>
              
             </ul>

           

           <h4>Reference</h4>
           <ul class="sidebar-nav">
             <li><a href="/versions/master/user-manual.html">Commands and Options</a></li>
             <li><a href="/versions/master/skylark/build-style.html">BUILD Style Guide</a></li>
             <li><a href="/versions/master/command-line-reference.html">Command Line Reference</a></li>
             <li><a href="/versions/master/test-encyclopedia.html">Writing Tests</a></li>
             <li><a href="/versions/master/build-event-protocol.html">Build Event Protocol</a></li>
             <li><a href="/versions/master/output_directories.html">Output Directory Layout</a></li>
             <li><a href="/versions/master/platforms.html">Platforms</a></li>
             <li><a href="/versions/master/toolchains.html">Toolchains</a></li>
           </ul>

            <h4>Extending Bazel</h4>
           <ul class="sidebar-nav">
              <li><a href="/versions/master/skylark/concepts.html">Extension Overview</a></li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#starlark-concepts" aria-expanded="false"
                    aria-controls="starlark-concepts">
                  Concepts<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="starlark-concepts">
                  <li><a href="/versions/master/skylark/macros.html">Macros</a></li>
                  <li><a href="/versions/master/skylark/rules.html">Rules</a></li>
                  <li><a href="/versions/master/skylark/depsets.html">Depsets</a></li>
                  <li><a href="/versions/master/skylark/aspects.html">Aspects</a></li>
                  <li><a href="/versions/master/skylark/repository_rules.html">Repository Rules</a></li>
                  <li><a href="/versions/master/skylark/config.html">Configurations</a></li>
                  <li><a href="/versions/master/skylark/faq.html">FAQ</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#starlark-practices" aria-expanded="false"
                    aria-controls="starlark-practices">
                  Best Practices<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="starlark-practices">
                  <li><a href="/versions/master/skylark/bzl-style.html">.bzl Style Guide</a></li>
                  <li><a href="/versions/master/skylark/testing.html">Testing</a></li>
                  <li><a href="https://skydoc.bazel.build" target="_blank">Documenting Rules</a></li>
                  <li><a href="https://github.com/bazelbuild/buildtools/tree/master/buildifier">Linter</a></li>
                  <li><a href="/versions/master/skylark/performance.html">Optimizing Performance</a></li>
                  <li><a href="/versions/master/skylark/deploying.html">Deploying Rules</a></li>
                  <li><a href="/versions/master/skylark/windows_tips.html">Writing rules on Windows</a></li>
                </ul>
              </li>

              <li><a href="https://github.com/bazelbuild/examples/tree/master/rules">Examples</a></li>
              <li><a href="/versions/master/skylark/lib/skylark-overview.html">API Reference</a></li>
              <li><a href="/versions/master/skylark/language.html">Starlark Language</a></li>
            </ul>
          </nav>
        </div>

        <div class="col-md-8">
          <div class="content">
            <h1 id="android-instrumentation-tests">Android Instrumentation Tests</h1>

<p><em>If you’re new to Bazel, please start with the <a href="tutorial/android-app.html">Building Android with
Bazel</a> tutorial.</em></p>

<p><img src="/assets/android_test.gif" alt="Running Android instrumentation tests in parallel" /></p>

<p><a href="be/android.html#android_instrumentation_test"><code class="highlighter-rouge">android_instrumentation_test</code></a>
allows developers to test their apps on Android emulators and devices.
It utilizes real Android framework APIs and the Android Test Library.</p>

<p>For hermeticity and reproducibility, Bazel creates and launches Android
emulators in a sandbox, ensuring that tests always run from a clean state. Each
test gets an isolated emulator instance, allowing tests to run in parallel
without passing states between them.</p>

<p>For more information on Android instrumentation tests, check out the <a href="https://developer.android.com/training/testing/unit-testing/instrumented-unit-tests.html">Android
developer
documentation</a>.</p>

<p>Please file issues in the <a href="https://github.com/bazelbuild/bazel/issues">GitHub issue tracker</a>.</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="#how-it-works">How it works</a></li>
  <li><a href="#prerequisites">Prerequisites</a></li>
  <li><a href="#getting-started">Getting started</a>
    <ul>
      <li><a href="#build-file"><code class="highlighter-rouge">BUILD</code> file</a></li>
      <li><a href="#workspace-dependencies"><code class="highlighter-rouge">WORKSPACE</code> dependencies</a></li>
    </ul>
  </li>
  <li><a href="#maven-dependencies">Maven dependencies</a></li>
  <li><a href="#choosing-an-android_device-target">Choosing an <code class="highlighter-rouge">android_device</code> target</a></li>
  <li><a href="#running-tests">Running tests</a>
    <ul>
      <li><a href="#headless-testing">Headless testing</a></li>
      <li><a href="#gui-testing">GUI testing</a></li>
      <li><a href="#testing-with-a-local-emulator-or-device">Testing with a local emulator or device</a></li>
    </ul>
  </li>
  <li><a href="#sample-projects">Sample projects</a></li>
  <li><a href="#espresso-setup">Espresso setup</a></li>
  <li><a href="#tips">Tips</a>
    <ul>
      <li><a href="#reading-test-logs">Reading test logs</a></li>
      <li><a href="#testing-against-multiple-api-levels">Testing against multiple API levels</a></li>
    </ul>
  </li>
  <li><a href="#known-issues">Known issues</a></li>
  <li><a href="#planned-features">Planned features</a></li>
</ul>

<h1 id="how-it-works">How it works</h1>

<p>When you run <code class="highlighter-rouge">bazel test</code> on an <code class="highlighter-rouge">android_instrumentation_test</code> target for the
first time, Bazel performs the following steps:</p>

<ol>
  <li>Builds the test APK, APK under test, and their transitive dependencies</li>
  <li>Creates, boots, and caches clean emulator states</li>
  <li>Starts the emulator</li>
  <li>Installs the APKs</li>
  <li>Runs tests utilizing the <a href="https://developer.android.com/training/testing/junit-runner.html#using-android-test-orchestrator">Android Test Orchestrator</a></li>
  <li>Shuts down the emulator</li>
  <li>Reports the results</li>
</ol>

<p>In subsequent test runs, Bazel boots the emulator from the clean, cached state
created in step 2, so there are no leftover states from previous runs. Caching
emulator state also speeds up test runs.</p>

<h1 id="prerequisites">Prerequisites</h1>

<p>Ensure your environment satisfies the following prerequisites:</p>

<ul>
  <li>
    <p><strong>Linux</strong>. Tested on Ubuntu 16.04, and 18.04.</p>
  </li>
  <li>
    <p><strong>Bazel 0.12.0</strong> or later. Verify the version by running <code class="highlighter-rouge">bazel info release</code>.</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bazel info release
release 0.12.0
</code></pre></div></div>

<ul>
  <li><strong>KVM</strong>. Bazel requires emulators to have <a href="https://developer.android.com/studio/run/emulator-acceleration.html#accel-check">hardware
acceleration</a>
with KVM on Linux. You can follow these
<a href="https://help.ubuntu.com/community/KVM/Installation">installation instructions</a>
for Ubuntu. Run <code class="highlighter-rouge">apt-get install cpu-checker &amp;&amp; kvm-ok</code> to verify that KVM has
the correct configuration. If it prints the following message, you’re good to
go:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kvm-ok
INFO: /dev/kvm exists
KVM acceleration can be used
</code></pre></div></div>

<ul>
  <li><strong>Xvfb</strong>. To run headless tests (for example, on CI servers), Bazel requires
the <a href="https://www.x.org/archive/X11R7.6/doc/man/man1/Xvfb.1.xhtml">X virtual framebuffer</a>.
Install it by running <code class="highlighter-rouge">apt-get install xvfb</code>. Verify that <code class="highlighter-rouge">Xvfb</code> is installed
correctly by running <code class="highlighter-rouge">which Xvfb</code> and ensure that it’s installed at
<code class="highlighter-rouge">/usr/bin/Xvfb</code>:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ which Xvfb
/usr/bin/Xvfb
</code></pre></div></div>

<h1 id="getting-started">Getting started</h1>

<p>Here is a typical target dependency graph of an <code class="highlighter-rouge">android_instrumentation_test</code>:</p>

<p><img src="/assets/android_instrumentation_test.png" alt="The target dependency graph on an Android instrumentation test" /></p>

<h2 id="build-file"><code class="highlighter-rouge">BUILD</code> file</h2>

<p>The graph translates into a <code class="highlighter-rouge">BUILD</code> file like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">android_instrumentation_test</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_test"</span><span class="p">,</span>
    <span class="n">test_app</span> <span class="o">=</span> <span class="s">":my_test_app"</span><span class="p">,</span>
    <span class="n">target_device</span> <span class="o">=</span> <span class="s">"@android_test_support//tools/android/emulated_devices/generic_phone:android_23_x86"</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Test app and library
</span><span class="n">android_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_test_app"</span><span class="p">,</span>
    <span class="n">instruments</span> <span class="o">=</span> <span class="s">":my_app"</span><span class="p">,</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="s">"AndroidTestManifest.xml"</span><span class="p">,</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">":my_test_lib"</span><span class="p">],</span>
    <span class="c1"># ...
</span><span class="p">)</span>

<span class="n">android_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_test_lib"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="n">glob</span><span class="p">([</span><span class="s">"javatest/**/*.java"</span><span class="p">]),</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">":my_app_lib"</span><span class="p">,</span>
        <span class="s">"@maven//:androidx_test_core"</span><span class="p">,</span>
        <span class="s">"@maven//:androidx_test_runner"</span><span class="p">,</span>
        <span class="s">"@maven//:androidx_test_espresso_espresso_core"</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="c1"># ...
</span><span class="p">)</span>

<span class="c1"># Target app and library under test
</span><span class="n">android_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_app"</span><span class="p">,</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="s">"AndroidManifest.xml"</span><span class="p">,</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">":my_app_lib"</span><span class="p">],</span>
    <span class="c1"># ...
</span><span class="p">)</span>

<span class="n">android_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_app_lib"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="n">glob</span><span class="p">([</span><span class="s">"java/**/*.java"</span><span class="p">]),</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"@maven//:androidx_appcompat_appcompat"</span><span class="p">,</span>
        <span class="s">"@maven//:androidx_annotation_annotation"</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="c1"># ...
</span><span class="p">)</span>
</code></pre></div></div>

<p>The main attributes of the rule <code class="highlighter-rouge">android_instrumentation_test</code> are:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">test_app</code>: An <code class="highlighter-rouge">android_binary</code> target. This target contains test code and
dependencies like Espresso and UIAutomator. The selected <code class="highlighter-rouge">android_binary</code>
target is required to specify an <code class="highlighter-rouge">instruments</code> attribute pointing to another
<code class="highlighter-rouge">android_binary</code>, which is the app under test.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">target_device</code>: An <code class="highlighter-rouge">android_device</code> target. This target describes the
specifications of the Android emulator which Bazel uses to create, launch and
run the tests. See the <a href="#choosing-an-android_device">section on choosing an Android
device</a> for more information.</p>
  </li>
</ul>

<p>The test app’s <code class="highlighter-rouge">AndroidManifest.xml</code> must include <a href="https://developer.android.com/studio/test/#configure_instrumentation_manifest_settings">an <code class="highlighter-rouge">&lt;instrumentation&gt;</code>
tag</a>.
This tag must specify the attributes for the <strong>package of the target app</strong> and
the <strong>fully qualified class name of the instrumentation test runner</strong>,
<code class="highlighter-rouge">androidx.test.runner.AndroidJUnitRunner</code>.</p>

<p>Here is an example <code class="highlighter-rouge">AndroidTestManifest.xml</code> for the test app:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
          <span class="na">xmlns:tools=</span><span class="s">"http://schemas.android.com/tools"</span>
          <span class="na">package=</span><span class="s">"com.example.android.app.test"</span>
    <span class="na">android:versionCode=</span><span class="s">"1"</span>
    <span class="na">android:versionName=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;instrumentation</span>
        <span class="na">android:name=</span><span class="s">"androidx.test.runner.AndroidJUnitRunner"</span>
        <span class="na">android:targetPackage=</span><span class="s">"com.example.android.app"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;uses-sdk</span>
        <span class="na">android:minSdkVersion=</span><span class="s">"16"</span>
        <span class="na">android:targetSdkVersion=</span><span class="s">"27"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;application</span> <span class="nt">&gt;</span>
       <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;/application&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</code></pre></div></div>

<h2 id="workspace-dependencies"><code class="highlighter-rouge">WORKSPACE</code> dependencies</h2>

<p>In order to use this rule, your project needs to depend on these external
repositories:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">@androidsdk</code>: The Android SDK. Download this through Android Studio.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">@android_test_support</code>: Hosts the test runner, emulator launcher, and
<code class="highlighter-rouge">android_device</code> targets. You can find the <a href="https://github.com/android/android-test/releases">latest release
here</a></p>
  </li>
</ul>

<p>Enable these dependencies by adding the following lines to your <code class="highlighter-rouge">WORKSPACE</code>
file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Android SDK
</span><span class="n">android_sdk_repository</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"androidsdk"</span><span class="p">,</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">"/path/to/sdk"</span><span class="p">,</span> <span class="c1"># or set ANDROID_HOME
</span><span class="p">)</span>

<span class="c1"># Android Test Support
</span><span class="n">ATS_COMMIT</span> <span class="o">=</span> <span class="s">"$COMMIT_HASH"</span>
<span class="n">http_archive</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"android_test_support"</span><span class="p">,</span>
    <span class="n">strip_prefix</span> <span class="o">=</span> <span class="s">"android-test-</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">ATS_COMMIT</span><span class="p">,</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">"https://github.com/android/android-test/archive/</span><span class="si">%</span><span class="s">s.tar.gz"</span> <span class="o">%</span> <span class="n">ATS_COMMIT</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">"@android_test_support//:repo.bzl"</span><span class="p">,</span> <span class="s">"android_test_repositories"</span><span class="p">)</span>
<span class="n">android_test_repositories</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="maven-dependencies">Maven dependencies</h1>

<p>For managing dependencies on Maven artifacts from repositories like <a href="https://maven.google.com">Google
Maven</a> or <a href="https://central.maven.org">Maven Central</a>,
we recommend using a Maven resolver like
<a href="https://github.com/bazelbuild/rules_jvm_external">rules_jvm_external</a>.</p>

<p>For the rest of this documentation, we will be using <code class="highlighter-rouge">rules_jvm_external</code> to
resolve and fetch dependencies from Maven repositories.</p>

<h1 id="choosing-an-android_device-target">Choosing an android_device target</h1>

<p><code class="highlighter-rouge">android_instrumentation_test.target_device</code> specifies which Android device to
run the tests on. These <code class="highlighter-rouge">android_device</code> targets are defined in
<a href="https://github.com/google/android-testing-support-library/tree/master/tools/android/emulated_devices"><code class="highlighter-rouge">@android_test_support</code></a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">bazel</span> <span class="n">query</span> <span class="o">--</span><span class="n">output</span><span class="o">=</span><span class="n">build</span> <span class="o">@</span><span class="n">android_test_support</span><span class="o">//</span><span class="n">tools</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">emulated_devices</span><span class="o">/</span><span class="n">generic_phone</span><span class="p">:</span><span class="n">android_23_x86</span>
<span class="c1"># .../external/android_test_support/tools/android/emulated_devices/generic_phone/BUILD:43:1
</span><span class="n">android_device</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"android_23_x86"</span><span class="p">,</span>
  <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s">"//visibility:public"</span><span class="p">],</span>
  <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s">"requires-kvm"</span><span class="p">],</span>
  <span class="n">generator_name</span> <span class="o">=</span> <span class="s">"generic_phone"</span><span class="p">,</span>
  <span class="n">generator_function</span> <span class="o">=</span> <span class="s">"make_device"</span><span class="p">,</span>
  <span class="n">generator_location</span> <span class="o">=</span> <span class="s">"tools/android/emulated_devices/generic_phone/BUILD:43"</span><span class="p">,</span>
  <span class="n">vertical_resolution</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
  <span class="n">horizontal_resolution</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
  <span class="n">ram</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
  <span class="n">screen_density</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
  <span class="n">cache</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
  <span class="n">vm_heap</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
  <span class="n">system_image</span> <span class="o">=</span> <span class="s">"@android_test_support//tools/android/emulated_devices/generic_phone:android_23_x86_images"</span><span class="p">,</span>
  <span class="n">default_properties</span> <span class="o">=</span> <span class="s">"@android_test_support//tools/android/emulated_devices/generic_phone:_android_23_x86_props"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>The device target names use this template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@android_test_support//tools/android/emulated_devices/${device_type}:${system}_${api_level}_x86_qemu2
</code></pre></div></div>

<p>In order to launch an <code class="highlighter-rouge">android_device</code>, the <code class="highlighter-rouge">system_image</code> for the selected API
level is required. To download the system image, use Android SDK’s
<code class="highlighter-rouge">tools/bin/sdkmanager</code>. For example, to download the system image for
<code class="highlighter-rouge">generic_phone:android_23_x86</code>, run <code class="highlighter-rouge">$sdk/tools/bin/sdkmanager
"system-images;android-23;default;x86"</code>.</p>

<p>To see the full list of supported <code class="highlighter-rouge">android_device</code> targets in
<code class="highlighter-rouge">@android_test_support</code>, run the following command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel query 'filter("x86_qemu2$", kind(android_device, @android_test_support//tools/android/emulated_devices/...:*))'
</code></pre></div></div>

<p>Bazel currently supports x86-based emulators only. For better performance, we
also recommend using <code class="highlighter-rouge">QEMU2</code> <code class="highlighter-rouge">android_device</code> targets instead of <code class="highlighter-rouge">QEMU</code> ones.</p>

<h1 id="running-tests">Running tests</h1>

<p>To run tests, add these lines to your project’s <code class="highlighter-rouge">&lt;project root&gt;/.bazelrc</code> file.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Configurations for testing with Bazel
# Select a configuration by running
# `bazel test //my:target --config={headless, gui, local_device}`

# Headless instrumentation tests (No GUI)
test:headless --test_arg=--enable_display=false

# Graphical instrumentation tests. Ensure that $DISPLAY is set.
test:gui --test_env=DISPLAY
test:gui --test_arg=--enable_display=true

# Testing with a local emulator or device. Ensure that `adb devices` lists the
# device.
# Run tests serially.
test:local_device --test_strategy=exclusive
# Use the local device broker type, as opposed to WRAPPED_EMULATOR.
test:local_device --test_arg=--device_broker_type=LOCAL_ADB_SERVER
# Uncomment and set $device_id if there is more than one connected device.
# test:local_device --test_arg=--device_serial_number=$device_id
</code></pre></div></div>

<p>Then, use one of the configurations to run tests:</p>

<ul>
  <li><code class="highlighter-rouge">bazel test //my/test:target --config=gui</code></li>
  <li><code class="highlighter-rouge">bazel test //my/test:target --config=headless</code></li>
  <li><code class="highlighter-rouge">bazel test //my/test:target --config=local_device</code></li>
</ul>

<p>Use <strong>only one configuration</strong> or tests will fail.</p>

<h2 id="headless-testing">Headless testing</h2>

<p>With <code class="highlighter-rouge">Xvfb</code>, it is possible to test with emulators without the graphical
interface, also known as headless testing. To disable the graphical interface
when running tests, pass the test argument <code class="highlighter-rouge">--enable_display=false</code> to Bazel:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel test //my/test:target --test_arg=--enable_display=false
</code></pre></div></div>

<h2 id="gui-testing">GUI testing</h2>

<p>If the <code class="highlighter-rouge">$DISPLAY</code> environment variable is set, it’s possible to enable the
graphical interface of the emulator while the test is running. To do this, pass
these test arguments to Bazel:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel test //my/test:target --test_arg=--enable_display --test_env=DISPLAY
</code></pre></div></div>

<h2 id="testing-with-a-local-emulator-or-device">Testing with a local emulator or device</h2>

<p>Bazel also supports testing directly on a locally launched emulator or connected
device. Pass the flags
<code class="highlighter-rouge">--test_strategy=exclusive</code> and
<code class="highlighter-rouge">--test_arg=--device_broker_type=LOCAL_ADB_SERVER</code> to enable local testing mode.
If there is more than one connected device, pass the flag
<code class="highlighter-rouge">--test_arg=--device_serial_number=$device_id</code> where <code class="highlighter-rouge">$device_id</code> is the id of
the device/emulator listed in <code class="highlighter-rouge">adb devices</code>.</p>

<h1 id="sample-projects">Sample projects</h1>

<p>If you are looking for canonical project samples, see the <a href="https://github.com/googlesamples/android-testing#experimental-bazel-support">Android testing
samples</a>
for projects using Espresso and UIAutomator.</p>

<h1 id="espresso-setup">Espresso setup</h1>

<p>If you write UI tests with <a href="https://developer.android.com/training/testing/espresso/">Espresso</a>
(<code class="highlighter-rouge">androidx.test.espresso</code>), you can use the following snippets to set up your
Bazel workspace with the list of commonly used Espresso artifacts and their
dependencies:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>androidx.test.espresso:espresso-core
androidx.test:rules
androidx.test:runner
javax.inject:javax.inject
org.hamcrest:java-hamcrest
junit:junit
</code></pre></div></div>

<p>One way to organize these dependencies is to create a <code class="highlighter-rouge">//:test_deps</code> shared
library:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># In &lt;project root&gt;/BUILD.bazel
</span>
<span class="n">java_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"test_deps"</span><span class="p">,</span>
    <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s">"//visibility:public"</span><span class="p">],</span>
    <span class="n">exports</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"@maven//:androidx_test_espresso_espresso_core"</span><span class="p">,</span>
        <span class="s">"@maven//:androidx_test_rules"</span><span class="p">,</span>
        <span class="s">"@maven//:androidx_test_runner"</span><span class="p">,</span>
        <span class="s">"@maven//:javax_inject_javax_inject"</span>
        <span class="s">"@maven//:org_hamcrest_java_hamcrest"</span><span class="p">,</span>
        <span class="s">"@maven//:junit_junit"</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Then, add the required dependencies in <code class="highlighter-rouge">&lt;project root&gt;/WORKSPACE</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span><span class="p">,</span> <span class="s">"http_archive"</span><span class="p">)</span>

<span class="n">RULES_JVM_EXTERNAL_TAG</span> <span class="o">=</span> <span class="s">"2.8"</span>
<span class="n">RULES_JVM_EXTERNAL_SHA</span> <span class="o">=</span> <span class="s">"79c9850690d7614ecdb72d68394f994fef7534b292c4867ce5e7dec0aa7bdfad"</span>

<span class="n">http_archive</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"rules_jvm_external"</span><span class="p">,</span>
    <span class="n">strip_prefix</span> <span class="o">=</span> <span class="s">"rules_jvm_external-</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">RULES_JVM_EXTERNAL_TAG</span><span class="p">,</span>
    <span class="n">sha256</span> <span class="o">=</span> <span class="n">RULES_JVM_EXTERNAL_SHA</span><span class="p">,</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://github.com/bazelbuild/rules_jvm_external/archive/</span><span class="si">%</span><span class="s">s.zip"</span> <span class="o">%</span> <span class="n">RULES_JVM_EXTERNAL_TAG</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">load</span><span class="p">(</span><span class="s">"@rules_jvm_external//:defs.bzl"</span><span class="p">,</span> <span class="s">"maven_install"</span><span class="p">)</span>

<span class="n">maven_install</span><span class="p">(</span>
    <span class="n">artifacts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"junit:junit:4.12"</span><span class="p">,</span>
        <span class="s">"javax.inject:javax.inject:1"</span><span class="p">,</span>
        <span class="s">"org.hamcrest:java-hamcrest:2.0.0.0"</span>
        <span class="s">"androidx.test.espresso:espresso-core:3.1.1"</span><span class="p">,</span>
        <span class="s">"androidx.test:rules:aar:1.1.1"</span><span class="p">,</span>
        <span class="s">"androidx.test:runner:aar:1.1.1"</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">repositories</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"https://maven.google.com"</span><span class="p">,</span>
        <span class="s">"https://repo1.maven.org/maven2"</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Finally, in your test <code class="highlighter-rouge">android_binary</code> target, add the <code class="highlighter-rouge">//:test_deps</code>
dependency:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">android_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_test_app"</span><span class="p">,</span>
    <span class="n">instruments</span> <span class="o">=</span> <span class="s">"//path/to:app"</span><span class="p">,</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"//:test_deps"</span><span class="p">,</span>
        <span class="c1"># ...
</span>    <span class="p">],</span>
    <span class="c1"># ...
</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="tips">Tips</h1>

<h2 id="reading-test-logs">Reading test logs</h2>

<p>Use <code class="highlighter-rouge">--test_output=errors</code> to print logs for failing tests, or
<code class="highlighter-rouge">--test_output=all</code> to print all test output. If you’re looking for an
individual test log, go to
<code class="highlighter-rouge">$PROJECT_ROOT/bazel-testlogs/path/to/InstrumentationTestTargetName</code>.</p>

<p>For example, the test logs for <code class="highlighter-rouge">BasicSample</code> canonical project are in
<code class="highlighter-rouge">bazel-testlogs/ui/espresso/BasicSample/BasicSampleInstrumentationTest</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ tree bazel-testlogs/ui/espresso/BasicSample/BasicSampleInstrumentationTest
.
├── adb.409923.log
├── broker_logs
│   ├── aapt_binary.10.ok.txt
│   ├── aapt_binary.11.ok.txt
│   ├── adb.12.ok.txt
│   ├── adb.13.ok.txt
│   ├── adb.14.ok.txt
│   ├── adb.15.fail.txt
│   ├── adb.16.ok.txt
│   ├── adb.17.fail.txt
│   ├── adb.18.ok.txt
│   ├── adb.19.fail.txt
│   ├── adb.20.ok.txt
│   ├── adb.21.ok.txt
│   ├── adb.22.ok.txt
│   ├── adb.23.ok.txt
│   ├── adb.24.fail.txt
│   ├── adb.25.ok.txt
│   ├── adb.26.fail.txt
│   ├── adb.27.ok.txt
│   ├── adb.28.fail.txt
│   ├── adb.29.ok.txt
│   ├── adb.2.ok.txt
│   ├── adb.30.ok.txt
│   ├── adb.3.ok.txt
│   ├── adb.4.ok.txt
│   ├── adb.5.ok.txt
│   ├── adb.6.ok.txt
│   ├── adb.7.ok.txt
│   ├── adb.8.ok.txt
│   ├── adb.9.ok.txt
│   ├── android_23_x86.1.ok.txt
│   └── exec-1
│       ├── adb-2.txt
│       ├── emulator-2.txt
│       └── mksdcard-1.txt
├── device_logcat
│   └── logcat1635880625641751077.txt
├── emulator_itCqtc.log
├── outputs.zip
├── pipe.log.txt
├── telnet_pipe.log.txt
└── tmpuRh4cy
    ├── watchdog.err
    └── watchdog.out

4 directories, 41 files
</code></pre></div></div>

<h2 id="reading-emulator-logs">Reading emulator logs</h2>

<p>The emulator logs for <code class="highlighter-rouge">android_device</code> targets are stored in the <code class="highlighter-rouge">/tmp/</code>
directory with the name <code class="highlighter-rouge">emulator_xxxxx.log</code>, where <code class="highlighter-rouge">xxxxx</code> is a
randomly-generated sequence of characters.</p>

<p>Use this command to find the latest emulator log:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls -1t /tmp/emulator_*.log | head -n 1
</code></pre></div></div>

<h2 id="testing-against-multiple-api-levels">Testing against multiple API levels</h2>

<p>If you would like to test against multiple API levels, you can use a list
comprehension to create test targets for each API level. For example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">API_LEVELS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"19"</span><span class="p">,</span>
    <span class="s">"20"</span><span class="p">,</span>
    <span class="s">"21"</span><span class="p">,</span>
    <span class="s">"22"</span><span class="p">,</span>
<span class="p">]</span>

<span class="p">[</span><span class="n">android_instrumentation_test</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"my_test_</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">API_LEVEL</span><span class="p">,</span>
    <span class="n">test_app</span> <span class="o">=</span> <span class="s">":my_test_app"</span><span class="p">,</span>
    <span class="n">target_device</span> <span class="o">=</span> <span class="s">"@android_test_support//tools/android/emulated_devices/generic_phone:android_</span><span class="si">%</span><span class="s">s_x86_qemu2"</span> <span class="o">%</span> <span class="n">API_LEVEL</span><span class="p">,</span>
<span class="p">)</span> <span class="k">for</span> <span class="n">API_LEVEL</span> <span class="ow">in</span> <span class="n">API_LEVELS</span><span class="p">]</span>
</code></pre></div></div>

<h1 id="known-issues">Known issues</h1>

<ul>
  <li><a href="https://github.com/bazelbuild/bazel/issues/4853">Forked adb server processes are not terminated after
tests</a></li>
  <li>While APK building works on all platforms (Linux, macOS, Windows), testing
only works on Linux.</li>
  <li>Even with <code class="highlighter-rouge">--config=local_adb</code>, users still need to specify
<code class="highlighter-rouge">android_instrumentation_test.target_device</code>.</li>
  <li>If using a local device or emulator, Bazel does not uninstall the APKs after
the test. Clean the packages by running this command: <code class="highlighter-rouge">adb shell pm list
packages com.example.android.testing | cut -d ':' -f 2 | tr -d '\r' | xargs
-L1 -t adb uninstall</code></li>
</ul>

<h1 id="planned-features">Planned features</h1>

<ul>
  <li>Code coverage collection</li>
  <li>macOS support</li>
  <li>Windows support</li>
  <li>Improved external dependency management</li>
  <li>Remote test caching and execution</li>
</ul>

<p>We are currently rewriting the Android rules in
<a href="skylark/concepts.html">Starlark</a>. The <code class="highlighter-rouge">android_instrumentation_test</code> rule will
be part of the rewrite, however, its usage will remain unchanged from the
end-user perspective.</p>

          </div>
        </div>

        <div class="col-md-2 sticky-sidebar">
            <div class="right-sidebar">
                <ul class="gh-links">
                    <li><a href="https://github.com/bazelbuild/bazel/issues/new?title=Documentation issue: Android Instrumentation Tests&body=Documentation URL: https://docs.bazel.build/versions/master/android-instrumentation-test.html&labels=type: documentation"><i class="fa fa-github"></i> Create issue</a></li>
                    <li id="gh-edit-list-item" class="default-hidden" aria-hidden="true"><a id="gh-edit" class="gh-edit default-hidden"><i class="fa fa-pencil" aria-hidden="true"></i> Edit this page</a></li>
                </ul>
                <script>
                 var versionDocsURLRegex = /\/versions\/[\w\.]+\/(.*)/;
                 var ghDocsBazeURL = 'https://github.com/bazelbuild/bazel/tree/master/site/docs/';
                 var editButton = document.getElementById('gh-edit');
                 var editButtonListItem = document.getElementById('gh-edit-list-item');
                 // if there is an edit button and we are not in the Build Encyclopedia
                 // or other generated files.
                 if (editButton
                     && window.location.pathname.match(versionDocsURLRegex)
                     && window.location.pathname.lastIndexOf('/be/') == -1
                     && window.location.pathname.lastIndexOf('/repo/') == -1
                     && window.location.pathname.lastIndexOf('/skylark/lib/') == -1) {
                     var docFile = window.location.pathname.match(versionDocsURLRegex)[1];
                     // some pages are not using markdown :(
                     if (docFile !== 'user-manual.html'
                         && docFile !== 'build-ref.html'
                         && docFile !== 'query.html'
                         && docFile !== 'test-encyclopedia.html') {
                         docFile = docFile.replace('html', 'md');
                     }
                     editButton.href = ghDocsBazeURL + docFile;
                     editButton.style.visibility = 'visible';
                     editButtonListItem.style.visibility = 'visible';
                 }
                </script>

                <ul class="page-toc">
<li class="toc-entry toc-h2"><a href="#build-file">BUILD file</a></li>
<li class="toc-entry toc-h2"><a href="#workspace-dependencies">WORKSPACE dependencies</a></li>
<li class="toc-entry toc-h2"><a href="#headless-testing">Headless testing</a></li>
<li class="toc-entry toc-h2"><a href="#gui-testing">GUI testing</a></li>
<li class="toc-entry toc-h2"><a href="#testing-with-a-local-emulator-or-device">Testing with a local emulator or device</a></li>
<li class="toc-entry toc-h2"><a href="#reading-test-logs">Reading test logs</a></li>
<li class="toc-entry toc-h2"><a href="#reading-emulator-logs">Reading emulator logs</a></li>
<li class="toc-entry toc-h2"><a href="#testing-against-multiple-api-levels">Testing against multiple API levels</a></li>
</ul>
            </div>
        </div>
      </div>
    </div>

    <!-- Satisfaction Survey -->
    <script async="" defer="" src="//www.google.com/insights/consumersurveys/async_survey?site=hihwpyy5e5kllsq62elzjrcgn4"></script>

        <footer class="footer">
      <div class="container">
  <div class="row">
    <div class="col-sm-4 col-md-2">
      <p>About</p>
      <ul class="list-unstyled">
        <li><a href="https://github.com/bazelbuild/bazel/wiki/Bazel-Users">Who's Using Bazel?</a></li>
        <li><a href="https://www.bazel.build/roadmap.html">Roadmap</a></li>
        <li><a href="https://www.bazel.build/contributing.html">Contribute</a></li>
        <li><a href="https://www.bazel.build/governance.html">Governance Plan</a></li>
        <li><a href="https://policies.google.com/privacy">Privacy Policy</a></li>
      </ul>
    </div>
    <div class="col-sm-4 col-md-2">
      <p>Support</p>
      <ul class="list-unstyled">
        <li><a href="http://stackoverflow.com/questions/tagged/bazel">Stack Overflow</a></li>
        <li><a href="https://github.com/bazelbuild/bazel/issues">Issue Tracker</a></li>
        <li><a href="/">Documentation</a></li>
        <li><a href="https://www.bazel.build/faq.html">FAQ</a></li>
        <li><a href="https://www.bazel.build/support.html">Support Policy</a></li>
      </ul>
    </div>
    <div class="col-sm-4 col-md-2">
      <p>Stay Connected</p>
      <ul class="list-unstyled">
        <li><a href="https://twitter.com/bazelbuild">Twitter</a></li>
        <li><a href="https://blog.bazel.build">Blog</a></li>
        <li><a href="https://github.com/bazelbuild/bazel">GitHub</a></li>
        <li><a href="https://groups.google.com/forum/#!forum/bazel-discuss">Discussion group</a></li>
      </ul>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <p class="text-muted">&copy; 2020 Google</p>
    </div>
  </div>
</div>

    </footer>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/assets/js/bootstrap.min.js"></script>

    <!-- Anchor JS -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>
    <script>
      // Automatically add anchors and links to all header elements that don't already have them.
      anchors.add();
    </script>

    <script>
      var shiftWindow = function() {
        if (location.hash.length !== 0) {
          window.scrollBy(0, -50);
        }
      };
      window.addEventListener("hashchange", shiftWindow);

      var highlightCurrentSidebarNav = function() {
        var href = location.pathname;
        var item = $('#sidebar-nav [href$="' + href + '"]');
        if (item) {
          var li = item.parent();
          li.addClass("active");

          if (li.parent() && li.parent().is("ul")) {
            do {
              var ul = li.parent();
              if (ul.hasClass("collapse")) {
                ul.collapse("show");
              }
              li = ul.parent();
            } while (li && li.is("li"));
          }
        }
      };

      $(document).ready(function() {
        // Scroll to anchor of location hash, adjusted for fixed navbar.
        window.setTimeout(function() {
          shiftWindow();
        }, 1);

        // Flip the caret when submenu toggles are clicked.
        $(".sidebar-submenu").on("show.bs.collapse", function() {
          var toggle = $('[href$="#' + $(this).attr('id') + '"]');
          if (toggle) {
            toggle.addClass("dropup");
          }
        });
        $(".sidebar-submenu").on("hide.bs.collapse", function() {
          var toggle = $('[href$="#' + $(this).attr('id') + '"]');
          if (toggle) {
            toggle.removeClass("dropup");
          }
        });

        // Highlight the current page on the sidebar nav.
        highlightCurrentSidebarNav();
      });
    </script>

    <!-- Google Analytics tracking code -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-61082125-1', 'auto');
      ga('send', 'pageview');
    </script>

  </body>
</html>

