<!-- /versions/master/foo/bar -> ["master", "foo", "bar"] -->
<!-- /versions/0.12.3/baz.md -> ["0.12.3", "baz.md"] -->





<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Only show Bazel version in title if it's a release -->
    <title>mobile-install - Bazel </title>

    <link rel="canonical" href="/versions/master/mobile-install.html">

    <!-- Webfont -->
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,500,700|Open+Sans:400,600,700,800" rel="stylesheet">

    <link rel="shortcut icon" type="image/png" href="/images/favicon.ico">

    <!-- Bootstrap -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/font-awesome.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom stylesheet -->
    <link rel="stylesheet" type="text/css" href="/css/main.css" />

    <!-- metadata -->
    <meta name="og:title" content="mobile-install"/>
    <meta name="og:image" content="/images/bazel-og-image.png"/>

    <!-- google search console verification -->
    <meta name="google-site-verification" content="ftWLOiP2hnDW4Cw3LUGEaXU83RVIpiyxwaXFFhoakzs" />
  </head>

  <body>
        <nav id="common-nav" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://www.bazel.build/">
            <img class="navbar-logo" src="/images/bazel-navbar.svg">
          </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/bazelbuild/bazel">GitHub</a></li>
          </ul>
          <form class="navbar-form navbar-right" action="/search.html" id="cse-search-box">
            <div class="form-group">
              <input type="hidden" name="cx" value="009927877080525621790:2pxlpaexqpc">
              <input type="hidden" name="cof" value="FORID:10">
              <input type="hidden" name="ie" value="UTF-8">
              <input type="search" name="q" id="q" class="form-control input-sm" placeholder="Search">
            </div>
          </form>
          <ul class="nav navbar-nav navbar-right">
            <li>
              <a href="/">Documentation</a>
            </li>
            <li>
              <a href="https://www.bazel.build/contributing.html">Contribute</a>
            </li>
            <li>
              <a href="https://blog.bazel.build">Blog</a>
            </li>
            <li><a href="https://twitter.com/bazelbuild" class="nav-icon"><i class="fa fa-twitter"></i></a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/bazel" class="nav-icon"><i class="fa fa-stack-overflow"></i></a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>


    <div class="container vpad">
      <div class="row">
        <div class="col-md-2">
          <a class="btn btn-default btn-lg btn-block sidebar-toggle"
              data-toggle="collapse" href="#sidebar-nav" aria-expanded="false"
              aria-controls="sidebar-nav">
            <i class="glyphicon glyphicon-menu-hamburger"></i> Navigation
          </a>

          <nav class="sidebar collapse" id="sidebar-nav">
            <select onchange="location.href=this.value">
                <option value="" selected disabled hidden>Version: master</option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/master/mobile-install.html">
                    master
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/2.1.0/mobile-install.html">
                    2.1.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/2.0.0/mobile-install.html">
                    2.0.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.2.0/mobile-install.html">
                    1.2.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.1.0/mobile-install.html">
                    1.1.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.0.0/mobile-install.html">
                    1.0.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.29.1/mobile-install.html">
                    0.29.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.29.0/mobile-install.html">
                    0.29.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.28.0/mobile-install.html">
                    0.28.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.27.0/mobile-install.html">
                    0.27.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.26.0/mobile-install.html">
                    0.26.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.25.0/mobile-install.html">
                    0.25.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.24.0/mobile-install.html">
                    0.24.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.23.0/mobile-install.html">
                    0.23.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.22.0/mobile-install.html">
                    0.22.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.21.0/mobile-install.html">
                    0.21.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.20.0/mobile-install.html">
                    0.20.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.19.2/mobile-install.html">
                    0.19.2
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.19.1/mobile-install.html">
                    0.19.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.18.1/mobile-install.html">
                    0.18.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.17.2/mobile-install.html">
                    0.17.2
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.17.1/mobile-install.html">
                    0.17.1
                </option>
                
            </select>

            <h4>Home</h4>
            <ul class="sidebar-nav">
              <li><a href="/versions/master/bazel-overview.html">Bazel Overview</a></li>
              <li><a href="/versions/master/bazel-vision.html">Bazel Vision</a></li>
              <li><a href="/versions/master/getting-started.html">Getting Started</a></li>
              <li><a href="/versions/master/backward-compatibility.html">Backward Compatibility</a></li>
            </ul>

            <h4>Installing and Using Bazel</h4>
            <ul class="sidebar-nav">

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#installing-menu" aria-expanded="false"
                    aria-controls="installing-menu">
                  Installing Bazel<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="installing-menu">
                   <li><a href="/versions/master/install.html">Installation Overview</a></li>
                   <li><a href="/versions/master/install-ubuntu.html">Installing on Ubuntu</a></li>
                   <li><a href="/versions/master/install-redhat.html">Installing on Fedora/CentOS</a></li>
                   <li><a href="/versions/master/install-os-x.html">Installing on macOS</a></li>
                   <li><a href="/versions/master/install-windows.html">Installing on Windows</a></li>
                   <li><a href="/versions/master/install-compile-source.html">Compiling from Source</a></li>
                   <li><a href="/versions/master/completion.html">Command-Line Completion</a></li>
                   <li><a href="/versions/master/ide.html">Integrating with IDEs</a></li>
                </ul>
              </li>

              
              <li class="sidebar-nav">
                <a href="/versions/master/updating-bazel.html">Updating Bazel</a>
              </li>
              

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#using-menu" aria-expanded="false"
                    aria-controls="using-menu">
                  Using Bazel<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="using-menu">
                  <li><a href="/versions/master/build-ref.html">Bazel Concepts</a></li>
                  <li><a href="/versions/master/guide.html">User's Guide (Bazel commands)</a></li>
                  <li><a href="/versions/master/external.html">External Dependencies</a></li>
                  <li><a href="/versions/master/configurable-attributes.html">Configurable Attributes</a></li>
                  <li><a href="/versions/master/best-practices.html">Best Practices</a></li>
                  <li><a href="/versions/master/memory-saving-mode.html">Memory-saving Mode</a></li>
                  <li><a href="/versions/master/windows.html">Using Bazel on Windows</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#build-files-menu" aria-expanded="false"
                    aria-controls="build-files-menu">
                  BUILD files<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="build-files-menu">
                  <li><a href="/versions/master/be/functions.html">Functions</a></li>
                  <li><a href="/versions/master/be/common-definitions.html">Common Definitions</a></li>
                  <li><a href="/versions/master/be/make-variables.html">"Make" Variables</a></li>
                  <li><a href="/versions/master/skylark/tutorial-sharing-variables.html">Sharing Variables</a></li>
                  <li><a href="/versions/master/skylark/tutorial-creating-a-macro.html">Creating a Macro</a></li>
                </ul>
              </li>

              
                <li><a href="/versions/master/rules.html">Rules</a></li>
              

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#query-menu" aria-expanded="false"
                    aria-controls="query-menu">
                  Queries<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="query-menu">
                  <li><a href="/versions/master/query-how-to.html">Bazel query</a></li>
                  <li><a href="/versions/master/cquery.html">Bazel cquery</a></li>
                  <li><a href="/versions/master/aquery.html">Bazel aquery</a></li>
                  <li><a href="/versions/master/query.html">Query Language</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#remote-execution-menu" aria-expanded="false"
                    aria-controls="remote-execution-menu">
                  Remote Execution<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="remote-execution-menu">
                   <li><a href="/versions/master/remote-execution.html">Remote Execution Overview</a></li>
                   <li><a href="/versions/master/remote-execution-rules.html">Guidelines for Remote Execution</a></li>
                   <li>
                      <a class="sidebar-nav-heading" data-toggle="collapse"
                          href="#troubleshoot-remote-execution-menu" aria-expanded="false"
                          aria-controls="troubleshoot-remote-execution-menu">
                        Troubleshooting Remote Execution<span class="caret"></span>
                      </a>
                      <ul class="collapse sidebar-nav sidebar-submenu" id="troubleshoot-remote-execution-menu">
                         <li><a href="/versions/master/remote-execution-sandbox.html">Troubleshooting Remote Execution with Bazel Sandbox</a></li>
                         <li><a href="/versions/master/workspace-log.html">Finding non-hermetic behavior in WORKSPACE rules</a></li>
                         <li><a href="/versions/master/remote-execution-caching-debug.html">Debugging Remote Cache Hit Rate</a></li>
                      </ul>
                  </li>
                   <li><a href="/versions/master/remote-execution-ci.html">Configuring Bazel CI for Remote Execution Rule Testing</a></li>
                 </ul>
              </li>

              <li>
                  <a class="sidebar-nav-heading" data-toggle="collapse"
                      href="#remote-caching-menu" aria-expanded="false"
                      aria-controls="remote-caching-menu">
                    Remote Caching<span class="caret"></span>
                  </a>
                  <ul class="collapse sidebar-nav sidebar-submenu" id="remote-caching-menu">
                     <li><a href="/versions/master/remote-caching.html">Remote Caching Overview</a></li>
                     <li><a href="/versions/master/remote-caching-debug.html">Debugging Remote Cache Hit Rate for Local Execution</a></li>
                  </ul>
              </li>
              
              <li><a href="/versions/master/platforms-intro.html">Building With Platforms</a></li>
              
             </ul>

           

           <h4>Reference</h4>
           <ul class="sidebar-nav">
             <li><a href="/versions/master/user-manual.html">Commands and Options</a></li>
             <li><a href="/versions/master/skylark/build-style.html">BUILD Style Guide</a></li>
             <li><a href="/versions/master/command-line-reference.html">Command Line Reference</a></li>
             <li><a href="/versions/master/test-encyclopedia.html">Writing Tests</a></li>
             <li><a href="/versions/master/build-event-protocol.html">Build Event Protocol</a></li>
             <li><a href="/versions/master/output_directories.html">Output Directory Layout</a></li>
             <li><a href="/versions/master/platforms.html">Platforms</a></li>
             <li><a href="/versions/master/toolchains.html">Toolchains</a></li>
           </ul>

            <h4>Extending Bazel</h4>
           <ul class="sidebar-nav">
              <li><a href="/versions/master/skylark/concepts.html">Extension Overview</a></li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#starlark-concepts" aria-expanded="false"
                    aria-controls="starlark-concepts">
                  Concepts<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="starlark-concepts">
                  <li><a href="/versions/master/skylark/macros.html">Macros</a></li>
                  <li><a href="/versions/master/skylark/rules.html">Rules</a></li>
                  <li><a href="/versions/master/skylark/depsets.html">Depsets</a></li>
                  <li><a href="/versions/master/skylark/aspects.html">Aspects</a></li>
                  <li><a href="/versions/master/skylark/repository_rules.html">Repository Rules</a></li>
                  <li><a href="/versions/master/skylark/config.html">Configurations</a></li>
                  <li><a href="/versions/master/skylark/faq.html">FAQ</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#starlark-practices" aria-expanded="false"
                    aria-controls="starlark-practices">
                  Best Practices<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="starlark-practices">
                  <li><a href="/versions/master/skylark/bzl-style.html">.bzl Style Guide</a></li>
                  <li><a href="/versions/master/skylark/testing.html">Testing</a></li>
                  <li><a href="https://skydoc.bazel.build" target="_blank">Documenting Rules</a></li>
                  <li><a href="https://github.com/bazelbuild/buildtools/tree/master/buildifier">Linter</a></li>
                  <li><a href="/versions/master/skylark/performance.html">Optimizing Performance</a></li>
                  <li><a href="/versions/master/skylark/deploying.html">Deploying Rules</a></li>
                  <li><a href="/versions/master/skylark/windows_tips.html">Writing rules on Windows</a></li>
                </ul>
              </li>

              <li><a href="https://github.com/bazelbuild/examples/tree/master/rules">Examples</a></li>
              <li><a href="/versions/master/skylark/lib/skylark-overview.html">API Reference</a></li>
              <li><a href="/versions/master/skylark/language.html">Starlark Language</a></li>
            </ul>
          </nav>
        </div>

        <div class="col-md-8">
          <div class="content">
            <h1 id="bazel-mobile-install">bazel mobile-install</h1>

<p class="lead">Fast iterative development for Android</p>

<h2 id="tldr">TL;DR</h2>

<p>To install small changes to an Android app very quickly, do the following:</p>

<ol>
  <li>Find the <code class="highlighter-rouge">android_binary</code> rule of the app you want to install.</li>
  <li>Disable Proguard by removing the <code class="highlighter-rouge">proguard_specs</code> attribute.</li>
  <li>Set the <code class="highlighter-rouge">multidex</code> attribute to <code class="highlighter-rouge">native</code>.</li>
  <li>Set the <code class="highlighter-rouge">dex_shards</code> attribute to <code class="highlighter-rouge">10</code>.</li>
  <li>Connect your device running ART (not Dalvik) over USB and enable USB
debugging on it.</li>
  <li>Run <code class="highlighter-rouge">bazel mobile-install :your_target</code>. App startup will be a little
slower than usual.</li>
  <li>Edit the code or Android resources.</li>
  <li>Run <code class="highlighter-rouge">bazel mobile-install --incremental :your_target</code>.</li>
  <li>Enjoy not having to wait a lot.</li>
</ol>

<p>Some command line options to Bazel that may be useful:</p>

<ul>
  <li><code class="highlighter-rouge">--adb</code> tells Bazel which adb binary to use</li>
  <li><code class="highlighter-rouge">--adb_arg</code> can be used to  add extra arguments to the command line of <code class="highlighter-rouge">adb</code>.
One useful application of this is to select which device you want to install
to if you have multiple devices connected to your workstation:
<code class="highlighter-rouge">bazel mobile-install --adb_arg=-s --adb_arg=&lt;SERIAL&gt; :your_target</code></li>
  <li><code class="highlighter-rouge">--start_app</code> automatically starts the app</li>
</ul>

<p>When in doubt, look at the
<a href="https://github.com/bazelbuild/bazel/tree/master/examples/android">example</a>
or <a href="https://groups.google.com/forum/#!forum/bazel-discuss">contact us</a>.</p>

<h2 id="introduction">Introduction</h2>

<p>One of the most important attributes of a developer’s toolchain is speed: there
is a world of difference between changing the code and seeing it run within a
second and having to wait minutes, sometimes hours, before you get any feedback
on whether your changes do what you expect them to.</p>

<p>Unfortunately, the traditional Android toolchain for building an .apk entails
many monolithic, sequential steps and all of these have to be done in order to
build an Android app. At Google, waiting five minutes to build a single-line
change was not unusual on larger projects like Google Maps.</p>

<p><code class="highlighter-rouge">bazel mobile-install</code> makes iterative development for Android much faster by
using a combination of change pruning, work sharding, and clever manipulation of
Android internals, all without changing any of your app’s code.</p>

<h2 id="problems-with-traditional-app-installation">Problems with traditional app installation</h2>

<p>We identified the following bottlenecks of building an Android app:</p>

<ul>
  <li>
    <p>Dexing. By default, “dx” is invoked exactly once in the build and it does not
know how to reuse work from previous builds: it dexes every method again, even
though only one method was changed.</p>
  </li>
  <li>
    <p>Uploading data to the device. adb does not use the full bandwidth of a USB 2.0
connection, and larger apps can take a lot of time to upload.  The entire app is
uploaded, even if only small parts have changed, for example, a resource or a
single method, so this can be a major bottleneck.</p>
  </li>
  <li>
    <p>Compilation to native code. Android L introduced ART, a new Android runtime,
which compiles apps ahead-of-time rather than compiling them just-in-time like
Dalvik. This makes apps much faster at the cost of longer installation
time. This is a good tradeoff for users because they typically install an app
once and use it many times, but results in slower development where an app is
installed many times and each version is run at most a handful of times.</p>
  </li>
</ul>

<h2 id="the-approach-of-bazel-mobile-install">The approach of <code class="highlighter-rouge">bazel mobile-install</code></h2>

<p><code class="highlighter-rouge">bazel mobile-install </code>makes the following improvements:</p>

<ul>
  <li>
    <p>Sharded dexing. After building the app’s Java code, Bazel shards the class
files into approximately equal-sized parts and invokes <code class="highlighter-rouge">dx</code> separately on
them. <code class="highlighter-rouge">dx</code> is not invoked on shards that did not change since the last build.</p>
  </li>
  <li>
    <p>Incremental file transfer. Android resources, .dex files, and native
libraries are removed from the main .apk and are stored in under a separate
mobile-install directory. This makes it possible to update code and Android
resources independently without reinstalling the whole app. Thus,
transferring the files takes less time and only the .dex files that have
changed are recompiled on-device.</p>
  </li>
  <li>
    <p>Loading parts of the app from outside the .apk. A tiny stub application is
put into the .apk that loads Android resources, Java code and native code
from the on-device mobile-install directory, then transfers control to the
actual app. This is all transparent to the app, except in a few corner cases
described below.</p>
  </li>
</ul>

<h3 id="sharded-dexing">Sharded Dexing</h3>

<p>Sharded dexing is reasonably straightforward: once the .jar files are built, a
<a href="https://github.com/bazelbuild/bazel/blob/master/src/tools/android/java/com/google/devtools/build/android/ziputils/DexMapper.java">tool</a>
shards them into separate .jar files of approximately equal size, then invokes
<code class="highlighter-rouge">dx</code> on those that were changed since the previous build. The logic that
determines which shards to dex is not specific to Android: it just uses the
general change pruning algorithm of Bazel.</p>

<p>The first version of the sharding algorithm simply ordered the .class files
alphabetically, then cut the list up into equal-sized parts, but this proved to
be suboptimal: if a class was added or removed (even a nested or an anonymous
one), it would cause all the classes alphabetically after it to shift by one,
resulting in dexing those shards again. Thus, we settled upon sharding not
individual classes, but Java packages instead. Of course, this still results in
dexing many shards if a new package is added or removed, but that is much less
frequent than adding or removing a single class.</p>

<p>The number of shards is controlled by the BUILD file (using the
<code class="highlighter-rouge">android_binary.dex_shards</code> attribute). In an ideal world, Bazel would
automatically determine how many shards are best, but Bazel currently must know
the set of actions (i.e. commands to be executed during the build) before
executing any of them, so it cannot determine the optimal number of shards
because it doesn’t know how many Java classes there will eventually be in the
app. Generally speaking, the more shards, the faster the build and the
installation will be, but the slower app startup becomes, because the dynamic
linker has to do more work. The sweet spot is usually between 10 and 50 shards.</p>

<h3 id="incremental-file-transfer">Incremental File Transfer</h3>

<p>After building the app, the next step is to install it, preferably with the
least effort possible. Installation consists of the following steps:</p>

<ol>
  <li>Installing the .apk (i.e. <code class="highlighter-rouge">adb install</code>)</li>
  <li>Uploading the .dex files, Android resources, and native libraries to the
mobile-install directory</li>
</ol>

<p>There is not much incrementality in the first step: the app is either installed
or not. Bazel currently relies on the user to indicate if it should do this step
through the <code class="highlighter-rouge">--incremental</code> command line option because it cannot determine in
all cases if it is necessary.</p>

<p>In the second step, the app’s files from the build are compared to an on-device
manifest file that lists which app files are on the device and their
checksums. Any new files are uploaded to the device, any files that have changed
are updated, and any files that have been removed are deleted from the
device. If the manifest is not present, it is assumed that every file needs to
be uploaded.</p>

<p>Note that it is possible to fool the incremental installation algorithm by
changing a file on the device, but not its checksum in the manifest. We could
have safeguarded against this by computing the checksum of the files on the
device, but this was deemed to be not worth the increase in installation time.</p>

<h3 id="the-stub-application">The Stub Application</h3>

<p>The stub application is where the magic to load the dexes, native code and
Android resources from the on-device <code class="highlighter-rouge">mobile-install</code> directory happens.</p>

<p>The actual loading is implemented by subclassing <code class="highlighter-rouge">BaseDexClassLoader</code> and is a
reasonably well-documented technique. This happens before any of the app’s
classes are loaded, so that any application classes that are in the apk can be
placed in the on-device <code class="highlighter-rouge">mobile-install</code> directory so that they can be updated
without <code class="highlighter-rouge">adb install</code>.</p>

<p>This needs to happen before any of the
classes of the app are loaded, so that no application class needs to be in the
.apk which would mean that changes to those classes would require a full
re-install.</p>

<p>This is accomplished by replacing the <code class="highlighter-rouge">Application</code> class specified in
<code class="highlighter-rouge">AndroidManifest.xml</code> with the
<a href="https://github.com/bazelbuild/bazel/blob/master/src/tools/android/java/com/google/devtools/build/android/incrementaldeployment/StubApplication.java">stub application</a>. This
takes control when the app is started, and tweaks the class loader and the
resource manager appropriately at the earliest moment (its constructor) using
Java reflection on the internals of the Android framework.</p>

<p>Another thing the stub application does is to copy the native libraries
installed by mobile-install to another location. This is necessary because the
dynamic linker needs the <code class="highlighter-rouge">X</code> bit to be set on the files, which is not possible to
do for any location accessible by a non-root <code class="highlighter-rouge">adb</code>.</p>

<p>Once all these things are done, the stub application then instantiates the
actual <code class="highlighter-rouge">Application</code> class, changing all references to itself to the actual
application within the Android framework.</p>

<h2 id="results">Results</h2>

<h3 id="performance">Performance</h3>

<p>In general, <code class="highlighter-rouge">bazel mobile-install</code> results in a 4x to 10x speedup of building
and installing large apps after a small change. We computed the following
numbers for a few Google products:</p>

<p><img src="/assets/mobile-install-performance.svg" /></p>

<p>This, of course, depends on the nature of the change: recompilation after
changing a base library takes more time.</p>

<h3 id="limitations">Limitations</h3>

<p>The tricks the stub application plays don’t work in every case. We have
identified the following cases where it does not work as expected:</p>

<ul>
  <li>
    <p>When <code class="highlighter-rouge">Context</code> is cast to the <code class="highlighter-rouge">Application</code> class in
<code class="highlighter-rouge">ContentProvider#onCreate()</code>. This method is called during application
startup before we have a chance to replace the instance of the <code class="highlighter-rouge">Application</code>
class, therefore, <code class="highlighter-rouge">ContentProvider</code> will still reference the stub application
instead of the real one. Arguably, this is not a bug since you are not
supposed to downcast <code class="highlighter-rouge">Context</code> like this, but this seems to happen in a few
apps at Google.</p>
  </li>
  <li>
    <p>Resources installed by <code class="highlighter-rouge">bazel mobile-install</code> are only available from within
the app. If resources are accessed by other apps via
<code class="highlighter-rouge">PackageManager#getApplicationResources()</code>, these resources will be from the
last non-incremental install.</p>
  </li>
  <li>
    <p>Devices that aren’t running ART. While the stub application works well on
Froyo and later, Dalvik has a bug that makes it think that the app is
incorrect if its code is distributed over multiple .dex files in certain
cases, for example, when Java annotations are used in a
<a href="https://code.google.com/p/android/issues/detail?id=78144">specific</a> way. As
long as your app doesn’t tickle these bugs, it should work with Dalvik, too
(note, however, that support for old Android versions isn’t exactly our
focus)</p>
  </li>
</ul>

          </div>
        </div>

        <div class="col-md-2 sticky-sidebar">
            <div class="right-sidebar">
                <ul class="gh-links">
                    <li><a href="https://github.com/bazelbuild/bazel/issues/new?title=Documentation issue: mobile-install&body=Documentation URL: https://docs.bazel.build/versions/master/mobile-install.html&labels=type: documentation"><i class="fa fa-github"></i> Create issue for this page</a></li>
                    <li id="gh-edit-list-item" class="default-hidden" aria-hidden="true"><a id="gh-edit" class="gh-edit default-hidden"><i class="fa fa-pencil" aria-hidden="true"></i> Edit this page</a></li>
                </ul>
                <script>
                 var versionDocsURLRegex = /\/versions\/[\w\.]+\/(.*)/;
                 var ghDocsBazeURL = 'https://github.com/bazelbuild/bazel/tree/master/site/docs/';
                 var editButton = document.getElementById('gh-edit');
                 var editButtonListItem = document.getElementById('gh-edit-list-item');
                 // if there is an edit button and we are not in the Build Encyclopedia
                 // or other generated files.
                 if (editButton
                     && window.location.pathname.match(versionDocsURLRegex)
                     && window.location.pathname.lastIndexOf('/be/') == -1
                     && window.location.pathname.lastIndexOf('/repo/') == -1
                     && window.location.pathname.lastIndexOf('/skylark/lib/') == -1) {
                     var docFile = window.location.pathname.match(versionDocsURLRegex)[1];
                     // some pages are not using markdown :(
                     if (docFile !== 'user-manual.html'
                         && docFile !== 'build-ref.html'
                         && docFile !== 'query.html'
                         && docFile !== 'test-encyclopedia.html') {
                         docFile = docFile.replace('html', 'md');
                     }
                     editButton.href = ghDocsBazeURL + docFile;
                     editButton.style.visibility = 'visible'
                     editButtonListItem.style.visibility = 'visible'
                 }
                </script>

                <ul class="page-toc">
<li class="toc-entry toc-h2"><a href="#tldr">TL;DR</a></li>
<li class="toc-entry toc-h2"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h2"><a href="#problems-with-traditional-app-installation">Problems with traditional app installation</a></li>
<li class="toc-entry toc-h2"><a href="#the-approach-of-bazel-mobile-install">The approach of bazel mobile-install</a>
<ul class="page-toc-sublist">
<li class="toc-entry toc-h3"><a href="#sharded-dexing">Sharded Dexing</a></li>
<li class="toc-entry toc-h3"><a href="#incremental-file-transfer">Incremental File Transfer</a></li>
<li class="toc-entry toc-h3"><a href="#the-stub-application">The Stub Application</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#results">Results</a>
<ul class="page-toc-sublist">
<li class="toc-entry toc-h3"><a href="#performance">Performance</a></li>
<li class="toc-entry toc-h3"><a href="#limitations">Limitations</a></li>
</ul>
</li>
</ul>
            </div>
        </div>
      </div>
    </div>

    <!-- Satisfaction Survey -->
    <script async="" defer="" src="//www.google.com/insights/consumersurveys/async_survey?site=hihwpyy5e5kllsq62elzjrcgn4"></script>

        <footer class="footer">
      <div class="container">
  <div class="row">
    <div class="col-sm-4 col-md-2">
      <p>About</p>
      <ul class="list-unstyled">
        <li><a href="https://github.com/bazelbuild/bazel/wiki/Bazel-Users">Who's Using Bazel?</a></li>
        <li><a href="https://www.bazel.build/roadmap.html">Roadmap</a></li>
        <li><a href="https://www.bazel.build/contributing.html">Contribute</a></li>
        <li><a href="https://www.bazel.build/governance.html">Governance Plan</a></li>
        <li><a href="https://policies.google.com/privacy">Privacy Policy</a></li>
      </ul>
    </div>
    <div class="col-sm-4 col-md-2">
      <p>Support</p>
      <ul class="list-unstyled">
        <li><a href="http://stackoverflow.com/questions/tagged/bazel">Stack Overflow</a></li>
        <li><a href="https://github.com/bazelbuild/bazel/issues">Issue Tracker</a></li>
        <li><a href="/">Documentation</a></li>
        <li><a href="https://www.bazel.build/faq.html">FAQ</a></li>
        <li><a href="https://www.bazel.build/support.html">Support Policy</a></li>
      </ul>
    </div>
    <div class="col-sm-4 col-md-2">
      <p>Stay Connected</p>
      <ul class="list-unstyled">
        <li><a href="https://twitter.com/bazelbuild">Twitter</a></li>
        <li><a href="https://blog.bazel.build">Blog</a></li>
        <li><a href="https://github.com/bazelbuild/bazel">GitHub</a></li>
        <li><a href="https://groups.google.com/forum/#!forum/bazel-discuss">Discussion group</a></li>
      </ul>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <p class="text-muted">&copy; 2020 Google</p>
    </div>
  </div>
</div>

    </footer>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/assets/js/bootstrap.min.js"></script>

    <!-- Anchor JS -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>
    <script>
      // Automatically add anchors and links to all header elements that don't already have them.
      anchors.add();
    </script>

    <script>
      var shiftWindow = function() {
        if (location.hash.length !== 0) {
          window.scrollBy(0, -50);
        }
      };
      window.addEventListener("hashchange", shiftWindow);

      var highlightCurrentSidebarNav = function() {
        var href = location.pathname;
        var item = $('#sidebar-nav [href$="' + href + '"]');
        if (item) {
          var li = item.parent();
          li.addClass("active");

          if (li.parent() && li.parent().is("ul")) {
            do {
              var ul = li.parent();
              if (ul.hasClass("collapse")) {
                ul.collapse("show");
              }
              li = ul.parent();
            } while (li && li.is("li"));
          }
        }
      };

      $(document).ready(function() {
        // Scroll to anchor of location hash, adjusted for fixed navbar.
        window.setTimeout(function() {
          shiftWindow();
        }, 1);

        // Flip the caret when submenu toggles are clicked.
        $(".sidebar-submenu").on("show.bs.collapse", function() {
          var toggle = $('[href$="#' + $(this).attr('id') + '"]');
          if (toggle) {
            toggle.addClass("dropup");
          }
        });
        $(".sidebar-submenu").on("hide.bs.collapse", function() {
          var toggle = $('[href$="#' + $(this).attr('id') + '"]');
          if (toggle) {
            toggle.removeClass("dropup");
          }
        });

        // Highlight the current page on the sidebar nav.
        highlightCurrentSidebarNav();
      });
    </script>

    <!-- Google Analytics tracking code -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-61082125-1', 'auto');
      ga('send', 'pageview');
    </script>

  </body>
</html>

