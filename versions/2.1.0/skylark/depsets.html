<!-- /versions/master/foo/bar -> ["master", "foo", "bar"] -->
<!-- /versions/0.12.3/baz.md -> ["0.12.3", "baz.md"] -->





<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Only show Bazel version in title if it's a release -->
    <title>Depsets - Bazel 2.1.0</title>

    <link rel="canonical" href="/versions/2.1.0/skylark/depsets.html">

    <!-- Webfont -->
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,500,700|Open+Sans:400,600,700,800" rel="stylesheet">

    <link rel="shortcut icon" type="image/png" href="/images/favicon.ico">

    <!-- Bootstrap -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/font-awesome.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom stylesheet -->
    <link rel="stylesheet" type="text/css" href="/css/main.css" />

    <!-- metadata -->
    <meta name="og:title" content="Depsets"/>
    <meta name="og:image" content="/images/bazel-og-image.png"/>

    <!-- google search console verification -->
    <meta name="google-site-verification" content="ftWLOiP2hnDW4Cw3LUGEaXU83RVIpiyxwaXFFhoakzs" />
  </head>

  <body>
        <nav id="common-nav" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://www.bazel.build/">
            <img class="navbar-logo" src="/images/bazel-navbar.svg">
          </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/bazelbuild/bazel">GitHub</a></li>
          </ul>
          <form class="navbar-form navbar-right" action="/search.html" id="cse-search-box">
            <div class="form-group">
              <input type="hidden" name="cx" value="009927877080525621790:2pxlpaexqpc">
              <input type="hidden" name="cof" value="FORID:10">
              <input type="hidden" name="ie" value="UTF-8">
              <input type="search" name="q" id="q" class="form-control input-sm" placeholder="Search">
            </div>
          </form>
          <ul class="nav navbar-nav navbar-right">
            <li>
              <a href="/">Documentation</a>
            </li>
            <li>
              <a href="https://www.bazel.build/contributing.html">Contribute</a>
            </li>
            <li>
              <a href="https://blog.bazel.build">Blog</a>
            </li>
            <li><a href="https://twitter.com/bazelbuild" class="nav-icon"><i class="fa fa-twitter"></i></a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/bazel" class="nav-icon"><i class="fa fa-stack-overflow"></i></a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>


    <div class="container vpad">
      <div class="row">
        <div class="col-md-2">
          <a class="btn btn-default btn-lg btn-block sidebar-toggle"
              data-toggle="collapse" href="#sidebar-nav" aria-expanded="false"
              aria-controls="sidebar-nav">
            <i class="glyphicon glyphicon-menu-hamburger"></i> Navigation
          </a>

          <nav class="sidebar collapse" id="sidebar-nav">
            <select onchange="location.href=this.value">
                <option value="" selected disabled hidden>Version: 2.1.0</option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/master/skylark/depsets.html">
                    master
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/3.2.0/skylark/depsets.html">
                    3.2.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/3.1.0/skylark/depsets.html">
                    3.1.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/3.0.0/skylark/depsets.html">
                    3.0.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/2.2.0/skylark/depsets.html">
                    2.2.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/2.1.0/skylark/depsets.html">
                    2.1.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/2.0.0/skylark/depsets.html">
                    2.0.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.2.0/skylark/depsets.html">
                    1.2.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.1.0/skylark/depsets.html">
                    1.1.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/1.0.0/skylark/depsets.html">
                    1.0.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.29.1/skylark/depsets.html">
                    0.29.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.29.0/skylark/depsets.html">
                    0.29.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.28.0/skylark/depsets.html">
                    0.28.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.27.0/skylark/depsets.html">
                    0.27.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.26.0/skylark/depsets.html">
                    0.26.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.25.0/skylark/depsets.html">
                    0.25.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.24.0/skylark/depsets.html">
                    0.24.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.23.0/skylark/depsets.html">
                    0.23.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.22.0/skylark/depsets.html">
                    0.22.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.21.0/skylark/depsets.html">
                    0.21.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.20.0/skylark/depsets.html">
                    0.20.0
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.19.2/skylark/depsets.html">
                    0.19.2
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.19.1/skylark/depsets.html">
                    0.19.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.18.1/skylark/depsets.html">
                    0.18.1
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.17.2/skylark/depsets.html">
                    0.17.2
                </option>
                
                <!-- reconstruct absolute url for the current page for each doc version -->
                <option value="/versions/0.17.1/skylark/depsets.html">
                    0.17.1
                </option>
                
            </select>

            <h3>Home</h3>
            <ul class="sidebar-nav">
              <li><a href="/versions/2.1.0/bazel-overview.html">Bazel overview</a></li>
              <li><a href="/versions/2.1.0/bazel-vision.html">Bazel vision</a></li>
              <li><a href="/versions/2.1.0/getting-started.html">Getting started</a></li>
              <li><a href="/versions/2.1.0/backward-compatibility.html">Backward compatibility</a></li>
            </ul>

            <h3>Installing Bazel</h3>
            <ul class="sidebar-nav">

              <li class="sidebar-nav">
                <a href="/versions/2.1.0/install.html">Installation overview</a>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#installing-menu" aria-expanded="false"
                    aria-controls="installing-menu">
                  Installation steps<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="installing-menu">

                   <li><a href="/versions/2.1.0/install-ubuntu.html">Ubuntu</a></li>
                   <li><a href="/versions/2.1.0/install-redhat.html">Fedora/CentOS</a></li>
                   <li><a href="/versions/2.1.0/install-os-x.html">macOS</a></li>
                   <li><a href="/versions/2.1.0/install-windows.html">Windows</a></li>
                   <li><a href="/versions/2.1.0/install-compile-source.html">Compiling from source</a></li>
                   <li><a href="/versions/2.1.0/completion.html">Command-line completion</a></li>
                   <li><a href="/versions/2.1.0/ide.html">Integrating with IDEs</a></li>
                </ul>
              </li>

              
              <li class="sidebar-nav">
                <a href="/versions/2.1.0/updating-bazel.html">Updating Bazel</a>
              </li>
              
            </ul>

            <h3>Tutorials</h3>
            <ul class="sidebar-nav">
                <li><a href="/versions/2.1.0/tutorial/cpp.html">C++</a></li>
                <li><a href="/versions/2.1.0/tutorial/java.html">Java</a></li>
                <li><a href="/versions/2.1.0/tutorial/android-app.html">Android</a></li>
                <li><a href="/versions/2.1.0/tutorial/ios-app.html">iOS</a></li>
            </ul>

            <h3>Using Bazel</h3>
            <ul class="sidebar-nav">
              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#using-menu" aria-expanded="false"
                    aria-controls="using-menu">
                  Concepts<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="using-menu">
                  <li><a href="/versions/2.1.0/build-ref.html">Core concepts</a></li>
                  <li><a href="/versions/2.1.0/external.html">External dependencies</a></li>
                  <li><a href="/versions/2.1.0/configurable-attributes.html">Configurable attributes</a></li>
                  <li><a href="/versions/master/platforms-intro.html">Platforms and toolchains</a></li>
                  <li><a href="/versions/master/visibility.html">Visibility</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#guides-menu" aria-expanded="false"
                    aria-controls="build-files-menu">
                  Guides<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="guides-menu">
                  <li><a href="/versions/2.1.0/guide.html">Running Bazel</a></li>
                  <li><a href="/versions/2.1.0/skylark/tutorial-creating-a-macro.html">Creating a macro</a></li>
                  <li><a href="/versions/2.1.0/memory-saving-mode.html">Optimizing memory</a></li>
                  <li><a href="/versions/2.1.0/windows.html">Building on Windows</a></li>
                </ul>
              </li>

              
                <li><a href="/versions/2.1.0/rules.html">Rules</a></li>
              

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#query-menu" aria-expanded="false"
                    aria-controls="query-menu">
                  Queries<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="query-menu">
                  <li><a href="/versions/2.1.0/query-how-to.html">The query command</a></li>
                  <li><a href="/versions/2.1.0/cquery.html">The cquery command</a></li>
                  <li><a href="/versions/2.1.0/aquery.html">The aquery command</a></li>
                  <li><a href="/versions/2.1.0/query.html">Query language</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#best-practices-menu" aria-expanded="false"
                    aria-controls="best-practices-menu">
                  Best practices<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="best-practices-menu">
                  <li><a href="/versions/2.1.0/best-practices.html">General best practices</a></li>
                  <li><a href="/versions/2.1.0/skylark/tutorial-sharing-variables.html">Sharing BUILD variables</a></li>
                </ul>
              </li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#remote-execution-menu" aria-expanded="false"
                    aria-controls="remote-execution-menu">
                  Remote execution<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="remote-execution-menu">
                   <li><a href="/versions/2.1.0/remote-execution.html">Overview</a></li>
                   <li><a href="/versions/2.1.0/remote-execution-rules.html">Guidelines</a></li>
                   <li>
                      <a class="sidebar-nav-heading" data-toggle="collapse"
                          href="#troubleshoot-remote-execution-menu" aria-expanded="false"
                          aria-controls="troubleshoot-remote-execution-menu">
                        Troubleshooting<span class="caret"></span>
                      </a>
                      <ul class="collapse sidebar-nav sidebar-submenu" id="troubleshoot-remote-execution-menu">
                         <li><a href="/versions/2.1.0/remote-execution-sandbox.html">Troubleshooting with Bazel sandbox</a></li>
                         <li><a href="/versions/2.1.0/workspace-log.html">Non-hermetic WORKSPACE rules</a></li>
                         <li><a href="/versions/2.1.0/remote-execution-caching-debug.html">Debugging remote cache hits</a></li>
                      </ul>
                  </li>
                   <li><a href="/versions/2.1.0/remote-execution-ci.html">Remote execution and CI</a></li>
                 </ul>
              </li>

              <li>
                  <a class="sidebar-nav-heading" data-toggle="collapse"
                      href="#remote-caching-menu" aria-expanded="false"
                      aria-controls="remote-caching-menu">
                    Remote caching<span class="caret"></span>
                  </a>
                  <ul class="collapse sidebar-nav sidebar-submenu" id="remote-caching-menu">
                     <li><a href="/versions/2.1.0/remote-caching.html">Overview</a></li>
                     <li><a href="/versions/2.1.0/remote-caching-debug.html">Debugging remote cache hits with local execution</a></li>
                  </ul>
              </li>
              
             </ul>

           

           <h3>Reference</h3>
           <ul class="sidebar-nav">
             <li><a href="/versions/2.1.0/user-manual.html">Commands and options</a></li>
             <li><a href="/versions/2.1.0/glossary.html">Glossary</a></li>
             <li><a href="/versions/2.1.0/be/overview.html">Build encyclopedia</a></li>
             <li><a href="/versions/2.1.0/test-encyclopedia.html">Test encyclopedia</a></li>
             <li><a href="/versions/2.1.0/command-line-reference.html">Command line reference</a></li>

             <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#build-files-menu" aria-expanded="false"
                    aria-controls="build-files-menu">
                  BUILD files<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="build-files-menu">
                  <li><a href="/versions/2.1.0/be/functions.html">Functions</a></li>
                  <li><a href="/versions/2.1.0/be/common-definitions.html">Common rule definitions</a></li>
                  <li><a href="/versions/2.1.0/be/make-variables.html">"Make" variables</a></li>
                  <li><a href="/versions/2.1.0/skylark/build-style.html">BUILD style guide</a></li>
                </ul>
             </li>

             <li><a href="/versions/2.1.0/build-event-protocol.html">Build Event Protocol</a></li>
             <li><a href="/versions/2.1.0/output_directories.html">Output directory layout</a></li>
             <li><a href="/versions/2.1.0/platforms.html">Platforms</a></li>
             <li><a href="/versions/2.1.0/toolchains.html">Toolchains</a></li>
           </ul>

           <h3>Extending Bazel</h3>
           <ul class="sidebar-nav">
              <li><a href="/versions/2.1.0/skylark/concepts.html">Extension overview</a></li>

              <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                    href="#starlark-concepts" aria-expanded="false"
                    aria-controls="starlark-concepts">
                  Concepts<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="starlark-concepts">
                  <li><a href="/versions/2.1.0/skylark/macros.html">Macros</a></li>
                  <li><a href="/versions/2.1.0/skylark/rules.html">Rules</a></li>
                  <li><a href="/versions/2.1.0/skylark/depsets.html">Depsets</a></li>
                  <li><a href="/versions/2.1.0/skylark/aspects.html">Aspects</a></li>
                  <li><a href="/versions/2.1.0/skylark/repository_rules.html">Repository rules</a></li>
                  <li><a href="/versions/2.1.0/skylark/config.html">Configurations</a></li>
                </ul>
              </li>

	            <li>
                <a class="sidebar-nav-heading" data-toggle="collapse"
                   href="#starlark-practices" aria-expanded="false"
                   aria-controls="starlark-practices">
                  Best practices<span class="caret"></span>
                </a>
                <ul class="collapse sidebar-nav sidebar-submenu" id="starlark-practices">
                  <li><a href="/versions/2.1.0/skylark/bzl-style.html">.bzl style guide</a></li>
                  <li><a href="/versions/2.1.0/skylark/testing.html">Testing extensions</a></li>
                  <li><a href="https://github.com/bazelbuild/stardoc">Documenting rules with Stardoc</a></li>
                  <li><a href="https://github.com/bazelbuild/buildtools/tree/master/buildifier">Linting</a></li>
                  <li><a href="/versions/2.1.0/skylark/performance.html">Optimizing performance</a></li>
                  <li><a href="/versions/2.1.0/skylark/deploying.html">Deploying rules</a></li>
                  <li><a href="/versions/2.1.0/skylark/windows_tips.html">Writing rules on Windows</a></li>
                </ul>
              </li>

              <li><a href="https://github.com/bazelbuild/examples/tree/master/rules">Examples</a></li>
              <li><a href="/versions/2.1.0/skylark/lib/skylark-overview.html">Extensions API</a></li>
              <li><a href="/versions/2.1.0/skylark/faq.html">FAQ</a></li>
              <li><a href="/versions/2.1.0/skylark/language.html">Starlark language</a></li>
            </ul>
          </nav>
        </div>

        <div class="col-md-8">
          <div class="content">
            <h1 id="depsets">Depsets</h1>

<p><a href="lib/depset.html">Depsets</a> are a specialized data structure for efficiently
collecting data across a target’s transitive dependencies. Since this use case
concerns the <a href="concepts.html#evaluation-model">analysis phase</a>, depsets are useful
for authors of rules and aspects, but probably not macros.</p>

<p>The main feature of depsets is that they support a time- and space-efficient
merge operation, whose cost is independent of the size of the existing contents.
Depsets also have well-defined ordering semantics.</p>

<p>Example uses of depsets include:</p>

<ul>
  <li>
    <p>storing the paths of all object files for a program’s libraries, which can
then be passed to a linker action</p>
  </li>
  <li>
    <p>for an interpreted language, storing the transitive source files that will
be included in an executable’s runfiles</p>
  </li>
</ul>

<p>If you don’t need the merge operation, consider using another type, such as
<a href="lib/list.html">list</a> or <a href="lib/dict.html">dict</a>.</p>

<ul id="markdown-toc">
  <li><a href="#full-example" id="markdown-toc-full-example">Full example</a></li>
  <li><a href="#description-and-operations" id="markdown-toc-description-and-operations">Description and operations</a></li>
  <li><a href="#order" id="markdown-toc-order">Order</a></li>
  <li><a href="#performance" id="markdown-toc-performance">Performance</a></li>
</ul>

<h2 id="full-example">Full example</h2>

<p>This example is available at
<a href="https://github.com/bazelbuild/examples/tree/master/rules/depsets">https://github.com/bazelbuild/examples/tree/master/rules/depsets</a>.</p>

<p>Suppose we have a hypothetical interpreted language Foo. In order to build each
<code class="highlighter-rouge">foo_binary</code> we need to know all the <code class="highlighter-rouge">*.foo</code> files that it directly or indirectly
depends on.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># //depsets:BUILD
</span>
<span class="n">load</span><span class="p">(</span><span class="s">":foo.bzl"</span><span class="p">,</span> <span class="s">"foo_library"</span><span class="p">,</span> <span class="s">"foo_binary"</span><span class="p">)</span>

<span class="c1"># Our hypothetical Foo compiler.
</span><span class="n">py_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"foocc"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"foocc.py"</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">foo_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"a"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"a.foo"</span><span class="p">,</span> <span class="s">"a_impl.foo"</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">foo_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"b"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"b.foo"</span><span class="p">,</span> <span class="s">"b_impl.foo"</span><span class="p">],</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">":a"</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">foo_library</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"c"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"c.foo"</span><span class="p">,</span> <span class="s">"c_impl.foo"</span><span class="p">],</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">":a"</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">foo_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"d"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"d.foo"</span><span class="p">],</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">":b"</span><span class="p">,</span> <span class="s">":c"</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># //depsets:foocc.py
</span>
<span class="c1"># "Foo compiler" that just concatenates its inputs to form its output.
</span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
  <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
  <span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"wt"</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"rt"</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</code></pre></div></div>

<p>Here, the transitive sources of the binary <code class="highlighter-rouge">d</code> are all of the <code class="highlighter-rouge">*.foo</code> files in
the <code class="highlighter-rouge">srcs</code> fields of <code class="highlighter-rouge">a</code>, <code class="highlighter-rouge">b</code>, <code class="highlighter-rouge">c</code>, and <code class="highlighter-rouge">d</code>. In order for the <code class="highlighter-rouge">foo_binary</code>
target to know about any file besides <code class="highlighter-rouge">d.foo</code>, the <code class="highlighter-rouge">foo_library</code> targets need to
pass them along in a provider. Each library receives the providers from its own
dependencies, adds its own immediate sources, and passes on a new provider with
the augmented contents. The <code class="highlighter-rouge">foo_binary</code> rule does the same, except that instead
of returning a provider, it uses the complete list of sources to construct a
command line for an action.</p>

<p>Here’s a complete implementation of the <code class="highlighter-rouge">foo_library</code> and <code class="highlighter-rouge">foo_binary</code> rules.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># //depsets/foo.bzl
</span>
<span class="c1"># A provider with one field, transitive_sources.
</span><span class="n">FooFiles</span> <span class="o">=</span> <span class="n">provider</span><span class="p">(</span><span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">"transitive_sources"</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_transitive_srcs</span><span class="p">(</span><span class="n">srcs</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
  <span class="s">"""Obtain the source files for a target and its transitive dependencies.

  Args:
    srcs: a list of source files
    deps: a list of targets that are direct dependencies
  Returns:
    a collection of the transitive sources
  """</span>
  <span class="k">return</span> <span class="n">depset</span><span class="p">(</span>
        <span class="n">srcs</span><span class="p">,</span>
        <span class="n">transitive</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep</span><span class="p">[</span><span class="n">FooFiles</span><span class="p">]</span><span class="o">.</span><span class="n">transitive_sources</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_foo_library_impl</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
  <span class="n">trans_srcs</span> <span class="o">=</span> <span class="n">get_transitive_srcs</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">srcs</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">FooFiles</span><span class="p">(</span><span class="n">transitive_sources</span><span class="o">=</span><span class="n">trans_srcs</span><span class="p">)]</span>

<span class="n">foo_library</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span>
    <span class="n">implementation</span> <span class="o">=</span> <span class="n">_foo_library_impl</span><span class="p">,</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"srcs"</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">label_list</span><span class="p">(</span><span class="n">allow_files</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="s">"deps"</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">label_list</span><span class="p">(),</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">_foo_binary_impl</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
  <span class="n">foocc</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">_foocc</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">out</span>
  <span class="n">trans_srcs</span> <span class="o">=</span> <span class="n">get_transitive_srcs</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">srcs</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>
  <span class="n">srcs_list</span> <span class="o">=</span> <span class="n">trans_srcs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
  <span class="n">ctx</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">executable</span> <span class="o">=</span> <span class="n">foocc</span><span class="p">,</span>
                  <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">srcs_list</span><span class="p">],</span>
                  <span class="n">inputs</span> <span class="o">=</span> <span class="n">srcs_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">foocc</span><span class="p">],</span>
                  <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span><span class="p">])</span>

<span class="n">foo_binary</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span>
    <span class="n">implementation</span> <span class="o">=</span> <span class="n">_foo_binary_impl</span><span class="p">,</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"srcs"</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">label_list</span><span class="p">(</span><span class="n">allow_files</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="s">"deps"</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">label_list</span><span class="p">(),</span>
        <span class="s">"_foocc"</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">Label</span><span class="p">(</span><span class="s">"//depsets:foocc"</span><span class="p">),</span>
                             <span class="n">allow_files</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="s">"host"</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s">"out"</span><span class="p">:</span> <span class="s">"</span><span class="si">%</span><span class="s">{name}.out"</span><span class="p">},</span>
<span class="p">)</span>
</code></pre></div></div>

<p>You can test this by copying these files into a fresh package, renaming the
labels appropriately, creating the source <code class="highlighter-rouge">*.foo</code> files with dummy content, and
building the <code class="highlighter-rouge">d</code> target.</p>

<h2 id="description-and-operations">Description and operations</h2>

<p>Conceptually, a depset is a directed acyclic graph (DAG) that typically looks
similar to the target graph. It is constructed from the leaves up to the root.
Each target in a dependency chain can add its own contents on top of the
previous without having to read or copy them.</p>

<p>Each node in the DAG holds a list of direct elements and a list of child nodes.
The contents of the depset are the transitive elements, i.e. the direct elements
of all the nodes. A new depset can be created using the
<a href="lib/globals.html#depset">depset</a> constructor: it accepts a list of direct
elements and another list of child nodes.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"c"</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"d"</span><span class="p">,</span> <span class="s">"e"</span><span class="p">],</span> <span class="n">transitive</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>    <span class="c1"># depset(["a", "b", "c"])
</span><span class="k">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>    <span class="c1"># depset(["d", "e", "a", "b", "c"])
</span></code></pre></div></div>

<p>To retrieve the contents of a depset, use the
<a href="lib/depset.html#to_list">to_list()</a> method. It returns a list of all transitive
elements, not including duplicates. There is no way to directly inspect the
precise structure of the DAG, although this structure does affect the order in
which the elements are returned.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"c"</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="s">"c"</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>              <span class="c1"># True
</span><span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"c"</span><span class="p">])</span>  <span class="c1"># True
</span></code></pre></div></div>

<p>The allowed items in a depset are restricted, just as the allowed keys in
dictionaries are restricted. In particular, depset contents may not be mutable.</p>

<p>Depsets use reference equality: a depset is equal to itself, but unequal to any
other depset, even if they have the same contents and same internal structure.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"c"</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">s</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>  <span class="c1"># True
</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"c"</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>  <span class="c1"># False
</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">d</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">d</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>  <span class="c1"># 2
</span></code></pre></div></div>

<p>To compare depsets by their contents, convert them to sorted lists.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"c"</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"c"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">to_list</span><span class="p">()))</span>  <span class="c1"># True
</span></code></pre></div></div>

<p>There is no ability to remove elements from a depset. If this is needed, you
must read out the entire contents of the depset, filter the elements you want to
remove, and reconstruct a new depset. This is not particularly efficient.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"c"</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"b"</span><span class="p">,</span> <span class="s">"c"</span><span class="p">])</span>

<span class="c1"># Compute set difference s - t. Precompute t.to_list() so it's not done
# in a loop, and convert it to a dictionary for fast membership tests.
</span><span class="n">t_items</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">to_list</span><span class="p">()}</span>
<span class="n">diff_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t_items</span><span class="p">]</span>
<span class="c1"># Convert back to depset if it's still going to be used for merge operations.
</span><span class="n">s</span> <span class="o">=</span> <span class="n">depset</span><span class="p">(</span><span class="n">diff_items</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># depset(["a"])
</span></code></pre></div></div>

<h2 id="order">Order</h2>

<p>The <code class="highlighter-rouge">to_list</code> operation performs a traversal over the DAG. The kind of traversal
depends on the <em>order</em> that was specified at the time the depset was
constructed. It is useful for Bazel to support multiple orders because sometimes
tools care about the order of their inputs. For example, a linker action may
need to ensure that if <code class="highlighter-rouge">B</code> depends on <code class="highlighter-rouge">A</code>, then <code class="highlighter-rouge">A.o</code> comes before <code class="highlighter-rouge">B.o</code> on the
linker’s command line. Other tools might have the opposite requirement.</p>

<p>Three traversal orders are supported: <code class="highlighter-rouge">postorder</code>, <code class="highlighter-rouge">preorder</code>, and
<code class="highlighter-rouge">topological</code>. The first two work exactly like <a href="https://en.wikipedia.org/wiki/Tree_traversal#Depth-first_search">tree
traversals</a>
except that they operate on DAGs and skip already visited nodes. The third order
works as a topological sort from root to leaves, essentially the same as
preorder except that shared children are listed only after all of their parents.
Preorder and postorder operate as left-to-right traversals, but note that within
each node direct elements have no order relative to children. For topological
order, there is no left-to-right guarantee, and even the
all-parents-before-child guarantee does not apply in the case that there are
duplicate elements in different nodes of the DAG.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This demonstrates different traversal orders.
</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
  <span class="n">cd</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"c"</span><span class="p">,</span> <span class="s">"d"</span><span class="p">],</span> <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">)</span>
  <span class="n">gh</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"g"</span><span class="p">,</span> <span class="s">"h"</span><span class="p">],</span> <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">depset</span><span class="p">([</span><span class="s">"a"</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"e"</span><span class="p">,</span> <span class="s">"f"</span><span class="p">],</span> <span class="n">transitive</span> <span class="o">=</span> <span class="p">[</span><span class="n">cd</span><span class="p">,</span> <span class="n">gh</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="n">create</span><span class="p">(</span><span class="s">"postorder"</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>  <span class="c1"># ["c", "d", "g", "h", "a", "b", "e", "f"]
</span><span class="k">print</span><span class="p">(</span><span class="n">create</span><span class="p">(</span><span class="s">"preorder"</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>   <span class="c1"># ["a", "b", "e", "f", "c", "d", "g", "h"]
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This demonstrates different orders on a diamond graph.
</span>
<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"a"</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"b"</span><span class="p">],</span> <span class="n">transitive</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">)</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"c"</span><span class="p">],</span> <span class="n">transitive</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">depset</span><span class="p">([</span><span class="s">"d"</span><span class="p">],</span> <span class="n">transitive</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">d</span>

<span class="k">print</span><span class="p">(</span><span class="n">create</span><span class="p">(</span><span class="s">"postorder"</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>    <span class="c1"># ["a", "b", "c", "d"]
</span><span class="k">print</span><span class="p">(</span><span class="n">create</span><span class="p">(</span><span class="s">"preorder"</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>     <span class="c1"># ["d", "b", "a", "c"]
</span><span class="k">print</span><span class="p">(</span><span class="n">create</span><span class="p">(</span><span class="s">"topological"</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>  <span class="c1"># ["d", "b", "c", "a"]
</span></code></pre></div></div>

<p>Due to how traversals are implemented, the order must be specified at the time
the depset is created with the constructor’s <code class="highlighter-rouge">order</code> keyword argument. If this
argument is omitted, the depset has the special <code class="highlighter-rouge">default</code> order, in which case
there are no guarantees about the order of any of its elements (except that it
is deterministic).</p>

<p>For safety, depsets with different orders cannot be merged with the <code class="highlighter-rouge">+</code> operator
unless one of them uses the default order; the resulting depset’s order is the
same as the left operand. Note that when two depsets of different order are
merged in this way, the child may appear to have had its elements rearranged
when it is traversed via the parent. <strong>The <code class="highlighter-rouge">+</code> operator is deprecated, anyway;
use the <code class="highlighter-rouge">transitive</code> argument instead.</strong></p>

<h2 id="performance">Performance</h2>

<p>To see the motivation for using depsets, consider what would have happened if we
had implemented <code class="highlighter-rouge">get_transitive_srcs()</code> without them. A naive way of writing
this function would be to collect the sources in a list.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_transitive_srcs</span><span class="p">(</span><span class="n">srcs</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
  <span class="n">trans_srcs</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
    <span class="n">trans_srcs</span> <span class="o">+=</span> <span class="n">dep</span><span class="p">[</span><span class="n">FooFiles</span><span class="p">]</span><span class="o">.</span><span class="n">transitive_sources</span>
  <span class="n">trans_srcs</span> <span class="o">+=</span> <span class="n">srcs</span>
  <span class="k">return</span> <span class="n">trans_srcs</span>
</code></pre></div></div>

<p>However, this does not take into account duplicates, so the source files for <code class="highlighter-rouge">a</code>
will appear twice on the command line and twice in the contents of the output
file.</p>

<p>The next alternative is using a general set, which can be simulated by a
dictionary where the keys are the elements and all the keys map to <code class="highlighter-rouge">True</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_transitive_srcs</span><span class="p">(</span><span class="n">srcs</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
  <span class="n">trans_srcs</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">dep</span><span class="p">[</span><span class="n">FooFiles</span><span class="p">]</span><span class="o">.</span><span class="n">transitive_sources</span><span class="p">:</span>
      <span class="n">trans_srcs</span><span class="p">[</span><span class="nb">file</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">srcs</span><span class="p">:</span>
    <span class="n">trans_srcs</span><span class="p">[</span><span class="nb">file</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">return</span> <span class="n">trans_srcs</span>
</code></pre></div></div>

<p>This gets rid of the duplicates, but it makes the order of the command line
arguments (and therefore the contents of the files) unspecified, although still
deterministic.</p>

<p>Moreover, both this approach and the list-based one are asymptotically worse
than the depset-based approach. Consider the case where there is a long chain of
dependencies on Foo libraries. Processing every rule requires copying all of the
transitive sources that came before it into a new data structure. This means
that the time and space cost for analyzing an individual library or binary
target is proportional to its own height in the chain. For a chain of length n,
foolib_1 ← foolib_2 ← … ← foolib_n, the overall cost is effectively the
<a href="https://en.wikipedia.org/wiki/Triangular_number">triangle sum</a> 1 + 2 + … + n,
which is O(n^2). This cost is wasteful because the library rule’s behavior is
not actually affected by the transitive sources.</p>

<p>Generally speaking, depsets should be used whenever you are accumulating more
and more information through your transitive dependencies. This helps ensure
that your build scales well as your target graph grows deeper. The exact
advantage will depend on how deep the target graph is and how many elements per
target are added.</p>

<p>To actually get the performance advantage, it’s important to not retrieve the
contents of the depset unnecessarily in library rules. One call to <code class="highlighter-rouge">to_list()</code>
at the end in a binary rule is fine, since the overall cost is just O(n). It’s
when many non-terminal targets try to call <code class="highlighter-rouge">to_list()</code> that we start to get into
quadratic behavior.</p>

<p>The <a href="performance.html">performance</a> page also contains information about using
depsets efficiently.</p>

          </div>
        </div>

        <div class="col-md-2 sticky-sidebar">
            <div class="right-sidebar">
                <ul class="gh-links">
                    <li><a href="https://github.com/bazelbuild/bazel/issues/new?title=Documentation issue: Depsets&body=Documentation URL: https://docs.bazel.build/versions/2.1.0/skylark/depsets.html&labels=type: documentation"><i class="fa fa-github"></i> Create issue</a></li>
                    <li id="gh-edit-list-item" class="default-hidden" aria-hidden="true"><a id="gh-edit" class="gh-edit default-hidden"><i class="fa fa-pencil" aria-hidden="true"></i> Edit this page</a></li>
                </ul>
                <script>
                 var versionDocsURLRegex = /\/versions\/[\w\.]+\/(.*)/;
                 var ghDocsBazeURL = 'https://github.com/bazelbuild/bazel/tree/master/site/docs/';
                 var editButton = document.getElementById('gh-edit');
                 var editButtonListItem = document.getElementById('gh-edit-list-item');
                 // if there is an edit button and we are not in the Build Encyclopedia
                 // or other generated files.
                 if (editButton
                     && window.location.pathname.match(versionDocsURLRegex)
                     && window.location.pathname.lastIndexOf('/be/') == -1
                     && window.location.pathname.lastIndexOf('/repo/') == -1
                     && window.location.pathname.lastIndexOf('/skylark/lib/') == -1
                     && window.location.pathname.lastIndexOf('/command-line-reference.html') == -1) {
                     var docFile = window.location.pathname.match(versionDocsURLRegex)[1];
                     // some pages are not using markdown :(
                     if (docFile !== 'user-manual.html'
                         && docFile !== 'build-ref.html'
                         && docFile !== 'query.html'
                         && docFile !== 'test-encyclopedia.html') {
                         docFile = docFile.replace('html', 'md');
                     }
                     editButton.href = ghDocsBazeURL + docFile;
                     editButton.style.visibility = 'visible';
                     editButtonListItem.style.visibility = 'visible';
                 }
                </script>

                <ul class="page-toc">
<li class="toc-entry toc-h2"><a href="#full-example">Full example</a></li>
<li class="toc-entry toc-h2"><a href="#description-and-operations">Description and operations</a></li>
<li class="toc-entry toc-h2"><a href="#order">Order</a></li>
<li class="toc-entry toc-h2"><a href="#performance">Performance</a></li>
</ul>
            </div>
        </div>
      </div>
    </div>

    <!-- Satisfaction Survey -->
    <script async="" defer="" src="//www.google.com/insights/consumersurveys/async_survey?site=hihwpyy5e5kllsq62elzjrcgn4"></script>

        <footer class="footer">
      <div class="container">
  <div class="row">
    <div class="col-sm-4 col-md-2">
      <p>About</p>
      <ul class="list-unstyled">
        <li><a href="https://github.com/bazelbuild/bazel/wiki/Bazel-Users">Who's Using Bazel?</a></li>
        <li><a href="https://www.bazel.build/roadmap.html">Roadmap</a></li>
        <li><a href="https://www.bazel.build/contributing.html">Contribute</a></li>
        <li><a href="https://www.bazel.build/governance.html">Governance Plan</a></li>
        <li><a href="https://policies.google.com/privacy">Privacy Policy</a></li>
        <li><a href="//sitemap.xml">Sitemap</a></li>
      </ul>
    </div>
    <div class="col-sm-4 col-md-2">
      <p>Support</p>
      <ul class="list-unstyled">
        <li><a href="http://stackoverflow.com/questions/tagged/bazel">Stack Overflow</a></li>
        <li><a href="https://github.com/bazelbuild/bazel/issues">Issue Tracker</a></li>
        <li><a href="/">Documentation</a></li>
        <li><a href="https://www.bazel.build/faq.html">FAQ</a></li>
        <li><a href="https://www.bazel.build/support.html">Support Policy</a></li>
      </ul>
    </div>
    <div class="col-sm-4 col-md-2">
      <p>Stay Connected</p>
      <ul class="list-unstyled">
        <li><a href="https://twitter.com/bazelbuild">Twitter</a></li>
        <li><a href="https://blog.bazel.build">Blog</a></li>
        <li><a href="https://github.com/bazelbuild/bazel">GitHub</a></li>
        <li><a href="https://groups.google.com/forum/#!forum/bazel-discuss">Discussion group</a></li>
        <li><a href="https://slack.bazel.build">Slack</a></li>
      </ul>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <p class="text-muted">&copy; 2020 Google</p>
    </div>
  </div>
</div>

    </footer>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/assets/js/bootstrap.min.js"></script>

    <!-- Anchor JS -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>
    <script>
      // Automatically add anchors and links to all header elements that don't already have them.
      anchors.add();
    </script>

    <script>
      var shiftWindow = function() {
        if (location.hash.length !== 0) {
          window.scrollBy(0, -50);
        }
      };
      window.addEventListener("hashchange", shiftWindow);

      var highlightCurrentSidebarNav = function() {
        var href = location.pathname;
        var item = $('#sidebar-nav [href$="' + href + '"]');
        if (item) {
          var li = item.parent();
          li.addClass("active");

          if (li.parent() && li.parent().is("ul")) {
            do {
              var ul = li.parent();
              if (ul.hasClass("collapse")) {
                ul.collapse("show");
              }
              li = ul.parent();
            } while (li && li.is("li"));
          }
        }
      };

      $(document).ready(function() {
        // Scroll to anchor of location hash, adjusted for fixed navbar.
        window.setTimeout(function() {
          shiftWindow();
        }, 1);

        // Flip the caret when submenu toggles are clicked.
        $(".sidebar-submenu").on("show.bs.collapse", function() {
          var toggle = $('[href$="#' + $(this).attr('id') + '"]');
          if (toggle) {
            toggle.addClass("dropup");
          }
        });
        $(".sidebar-submenu").on("hide.bs.collapse", function() {
          var toggle = $('[href$="#' + $(this).attr('id') + '"]');
          if (toggle) {
            toggle.removeClass("dropup");
          }
        });

        // Highlight the current page on the sidebar nav.
        highlightCurrentSidebarNav();
      });
    </script>

    <!-- Google Analytics tracking code -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-61082125-1', 'auto');
      ga('send', 'pageview');
    </script>

  </body>
</html>

